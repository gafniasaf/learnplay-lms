# Parent Linking Flow - Acceptance Criteria

## Overview
This document defines the acceptance criteria for the parent-child linking feature, which allows parents to link to their children via one-time codes generated by teachers.

## Database Schema

### Tables

#### `child_codes`
- `id` (uuid, primary key)
- `code` (text, unique, not null) - 6-character alphanumeric code
- `student_id` (uuid, not null) - References the student
- `used` (boolean, default false) - Whether code has been used
- `created_at` (timestamp, default now())
- `expires_at` (timestamp, default now() + 30 days)

#### `parent_children`
- `id` (uuid, primary key)
- `parent_id` (uuid, not null) - References parent user
- `child_id` (uuid, not null) - References student user
- `linked_at` (timestamp, default now())

### RLS Policies

#### `child_codes` policies:
- `students view own codes`: Students can see their own codes
- `teachers create student codes`: Teachers/school admins can create codes for students in their org
- `teachers view org student codes`: Teachers/school admins can view codes for students in their org

#### `parent_children` policies:
- `parents view own children`: Parents can view their linked children
- `children view own parents`: Children can view their linked parents
- `parents link children`: Parents can insert links (when they use a code)
- `parents unlink children`: Parents can delete links (unlink their children)

## API Endpoints

### 1. Create Child Code (Teacher)
**Endpoint:** `create-child-code`  
**Method:** POST  
**Auth:** Teacher or School Admin

**Input:**
```json
{
  "studentId": "uuid"
}
```

**Output:**
```json
{
  "code": "ABC123",
  "expiresAt": "2025-11-17T...",
  "isNew": true
}
```

**Behavior:**
- Verifies requester is teacher/school admin
- Verifies student belongs to same organization
- Checks for existing unused, unexpired code
- If exists, returns existing code with `isNew: false`
- If not, generates new 6-character code
- Inserts into `child_codes` table
- Returns code and expiration

**Error Cases:**
- 401: Not authenticated
- 403: Not authorized (not teacher/admin or wrong org)
- 404: Student not found

### 2. Link Child (Parent)
**Endpoint:** `link-child`  
**Method:** POST  
**Auth:** Parent

**Input:**
```json
{
  "code": "ABC123"
}
```

**Output:**
```json
{
  "success": true,
  "message": "Successfully linked to [Child Name]",
  "childName": "John Doe",
  "alreadyLinked": false
}
```

**Behavior:**
- Verifies requester has "parent" role
- Looks up code in `child_codes` table
- Validates code:
  - Exists
  - Not used (`used = false`)
  - Not expired (`expires_at > now()`)
- Checks if parent is trying to link to themselves (forbidden)
- Checks if link already exists in `parent_children`
- If already linked, returns success with `alreadyLinked: true`
- If not linked:
  - Creates link in `parent_children`
  - Marks code as used in `child_codes`
- Fetches child's name from `profiles`
- Returns success message

**Error Cases:**
- 401: Not authenticated
- 403: Not a parent
- 400: Invalid code format (not 6 characters)
- 404: Code not found
- 410: Code already used
- 410: Code expired
- 400: Cannot link to yourself

## Frontend Components

### 1. Teacher Students Page (`/teacher/students`)
**Location:** `src/pages/teacher/Students.tsx`

**Features:**
- Lists all students in the teacher's organization
- Each student has a "Parent Code" button
- Clicking button generates or retrieves code
- Shows dialog with:
  - Generated code (large, monospace font)
  - Expiration date
  - Copy button (copies code to clipboard)
  - Instructions for parents

**API Calls:**
- `listOrgStudents()` - Fetches list of students
- `createChildCode(studentId)` - Generates/retrieves code

**State Management:**
- Selected student for code generation
- Generated code display
- Copy status feedback

### 2. Parent Link Child Page (`/parent/link-child`)
**Location:** `src/pages/parent/LinkChild.tsx`

**Features:**
- Input field for 6-character code
- Auto-converts input to uppercase
- Max length 6 characters
- Submit button (disabled until 6 characters entered)
- Help card with instructions
- Back to dashboard button

**API Calls:**
- `linkChild(code)` - Links parent to child using code

**Validation:**
- Client-side: Exactly 6 characters required
- Displays appropriate error toasts:
  - Invalid code
  - Already used code
  - Expired code
  - Generic errors

**Success Flow:**
- Shows success toast with child's name
- Invalidates parent-dashboard query
- Navigates to parent dashboard (unless already linked)

## Navigation

### Teacher Navigation
- "Students" link in Teacher Dashboard buttons
- `/teacher/students` route
- Listed in nav.ts under teacher role

### Parent Navigation
- "Link Child" button on Parent Dashboard
- "Link Your First Child" button when no children
- `/parent/link-child` route
- Listed in nav.ts under parent role

## Security Requirements

### RLS Enforcement
1. **Code Creation:**
   - Only teachers/school admins can create codes
   - Can only create codes for students in their organization
   - Uses `user_has_org_role()` function for verification

2. **Code Usage:**
   - Only parents can use codes to link children
   - Code must be unused and unexpired
   - Cannot link to self

3. **Viewing Links:**
   - Parents can only view their own linked children
   - Children can only view their own linked parents
   - No cross-user data access

### Edge Function Security
- Both functions verify user authentication
- Both functions verify user roles (teacher/admin vs parent)
- Both functions verify organization membership (create-child-code)
- Both functions validate input using Zod schemas

## Acceptance Testing

### Test Case 1: Teacher Generates Code
**Steps:**
1. Log in as teacher
2. Navigate to `/teacher/students`
3. Click "Parent Code" button for a student
4. Verify code is displayed
5. Click "Copy Code" button
6. Verify clipboard contains code
7. Close dialog and click button again
8. Verify same code is shown (not a new one)

**Expected Results:**
- Code is 6 characters, uppercase alphanumeric
- Code can be copied to clipboard
- Same code is returned on subsequent calls
- Expiration date shows 30 days from first generation

### Test Case 2: Parent Links Child (Success)
**Steps:**
1. Generate code as teacher (from Test Case 1)
2. Log out and log in as parent
3. Navigate to `/parent/link-child`
4. Enter the 6-character code
5. Click "Link Child"
6. Verify success message
7. Navigate to `/parent/dashboard`
8. Verify child appears in dashboard

**Expected Results:**
- Success toast shows child's name
- Parent dashboard shows linked child
- Child's courses and assignments visible

### Test Case 3: Code Already Used
**Steps:**
1. Use code to link child (Test Case 2)
2. Log out and log in as different parent
3. Try to use same code
4. Verify error message

**Expected Results:**
- Error toast: "This code has already been used"
- No link created
- Parent dashboard unchanged

### Test Case 4: Code Validation
**Steps:**
1. Navigate to `/parent/link-child`
2. Try to submit with less than 6 characters
3. Verify submit button is disabled
4. Enter 6 characters
5. Verify submit button is enabled
6. Enter invalid code (e.g., "ZZZZZZ")
7. Click submit
8. Verify error message

**Expected Results:**
- Submit disabled until 6 characters
- Invalid code shows appropriate error
- Form remains usable after error

### Test Case 5: Already Linked
**Steps:**
1. Link child using valid code (Test Case 2)
2. Try to use same code again
3. Verify appropriate message

**Expected Results:**
- Message indicates child already linked
- No error shown
- Parent dashboard shows child normally

### Test Case 6: Code Expiration
**Steps:**
1. Manually set code expiration in database to past date
2. Try to use expired code
3. Verify error message

**Expected Results:**
- Error toast: "This code has expired"
- No link created

### Test Case 7: RLS Enforcement
**Steps:**
1. Try to access codes directly via Supabase client
2. Try to create link directly in `parent_children` table
3. Verify RLS blocks unauthorized access

**Expected Results:**
- Cannot view codes for other students
- Cannot create links for other parents
- RLS policies enforce security

## Manual Testing Commands

### Check RLS Policies
```sql
-- View child_codes policies
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
FROM pg_policies
WHERE tablename = 'child_codes';

-- View parent_children policies
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
FROM pg_policies
WHERE tablename = 'parent_children';
```

### Test Code Generation
```sql
-- Check for existing codes
SELECT code, student_id, used, created_at, expires_at
FROM child_codes
WHERE student_id = '[student-id]'
ORDER BY created_at DESC;
```

### Test Link Creation
```sql
-- Check parent-child links
SELECT pc.*, 
       p1.full_name as parent_name,
       p2.full_name as child_name
FROM parent_children pc
JOIN profiles p1 ON p1.id = pc.parent_id
JOIN profiles p2 ON p2.id = pc.child_id
WHERE pc.parent_id = '[parent-id]';
```

## Edge Function Logs to Monitor

### create-child-code logs should show:
- Request received with studentId
- Auth check passed
- Student org verification
- Existing code found/new code generated
- Response sent

### link-child logs should show:
- Request received with code
- Auth check passed
- Code validation
- Link creation/already exists
- Code marked as used
- Response sent with child name

## Success Criteria

✅ Teacher can generate parent linking codes for students  
✅ Generated codes are unique, 6 characters, uppercase  
✅ Codes expire after 30 days  
✅ Same code is returned if unused and unexpired  
✅ Parent can enter code on Link Child page  
✅ Valid code creates parent-child link  
✅ Used code cannot be reused  
✅ Expired code cannot be used  
✅ Parent cannot link to themselves  
✅ Linked child appears on Parent Dashboard  
✅ RLS policies prevent unauthorized access  
✅ All error cases show appropriate messages  
✅ Navigation includes all necessary links  

## Implementation Status

✅ Database schema created with RLS policies  
✅ Edge functions created and deployed  
✅ API functions in `src/lib/api.ts`  
✅ Teacher Students page with code generation  
✅ Parent LinkChild page with code entry  
✅ Routes configured in App.tsx  
✅ Navigation updated in nav.ts  

## Notes

- Codes are case-insensitive (auto-converted to uppercase)
- TTL is 30 days from generation
- One code per student at a time (not used + not expired)
- Teachers can "refresh" by letting old code expire or be used
- No bulk linking - one code per child
- Parents can link multiple children with separate codes
