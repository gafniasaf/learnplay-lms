<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>e-Xpert SAM | Je lesplan in 1 klik</title>
  <style>
    /* ========================================
       CSS RESET & DESIGN TOKENS
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #3b82f6;
      --secondary: #10b981;
      --accent: #f59e0b;
      --dark: #0f172a;
      --dark-surface: #1e293b;
      --dark-elevated: #334155;
      --light: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-full: 9999px;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiJ-Ek-_EeA.woff2') format('woff2');
    }

    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark);
      color: var(--light);
      display: flex;
      flex-direction: column;
    }

    /* ========================================
       LAYOUT STRUCTURE
       ======================================== */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      background: var(--dark);
    }

    /* ========================================
       HEADER
       ======================================== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--dark-surface);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      flex-shrink: 0;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-logo {
      width: 36px;
      height: 36px;
      background: var(--gradient);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .header-title {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .header-subtitle {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .scope-toggle {
      display: flex;
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius-full);
      padding: 4px;
    }

    .scope-btn {
      padding: 6px 14px;
      border: none;
      background: transparent;
      color: var(--gray-400);
      font-size: 0.8125rem;
      font-weight: 500;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.2s;
    }

    .scope-btn:hover {
      color: var(--light);
    }

    .scope-btn.active {
      background: var(--primary);
      color: white;
    }

    .clear-btn {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: var(--gray-300);
      font-size: 0.8125rem;
      font-weight: 500;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .clear-btn:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.2);
    }

    .settings-btn {
      padding: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: var(--gray-300);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-btn:hover {
      background: rgba(255,255,255,0.05);
    }

    .settings-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* ========================================
       SETTINGS PANEL
       ======================================== */
    .settings-panel {
      background: var(--dark-surface);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .settings-panel.open {
      max-height: 200px;
      padding: 16px 24px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .settings-select {
      padding: 10px 14px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius-md);
      color: var(--light);
      font-size: 0.875rem;
      font-family: inherit;
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 36px;
    }

    .settings-select:focus {
      border-color: var(--primary);
    }

    .settings-select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .settings-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .settings-row .settings-select {
      flex: 1;
    }

    .refresh-btn {
      padding: 10px 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: var(--gray-300);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .refresh-btn:hover {
      background: rgba(255,255,255,0.05);
    }

    .refresh-btn svg {
      width: 14px;
      height: 14px;
    }

    .refresh-btn.loading svg {
      animation: spin 1s linear infinite;
    }

    .selected-material {
      font-size: 0.75rem;
      color: var(--gray-400);
      margin-top: 4px;
    }

    .selected-material strong {
      color: var(--primary-light);
    }

    /* ========================================
       ERROR ALERT
       ======================================== */
    .error-alert {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      margin: 16px 24px 0;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      animation: fadeInUp 0.3s ease;
    }

    .error-alert-icon {
      color: var(--error);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .error-alert-content {
      flex: 1;
    }

    .error-alert-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--error);
      margin-bottom: 4px;
    }

    .error-alert-text {
      font-size: 0.8125rem;
      color: var(--gray-300);
    }

    .error-alert-close {
      background: none;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      padding: 4px;
      display: flex;
    }

    .error-alert-close:hover {
      color: var(--light);
    }

    /* ========================================
       MAIN CONTENT AREA
       ======================================== */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 0;
      overflow: hidden;
      /* Critical for grid child to respect boundaries */
      min-height: 0;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      .side-panel {
        display: none;
      }
    }

    /* ========================================
       CHAT PANEL
       ======================================== */
    .chat-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-right: 1px solid rgba(255,255,255,0.08);
      /* Critical for flex child to allow scroll */
      min-height: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      overscroll-behavior: contain;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
      /* Ensure this container is the scroll parent */
      min-height: 0;
    }

    /* Custom scrollbar for chat */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      width: 80px;
      height: 80px;
      background: var(--gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-bottom: 24px;
    }

    .empty-state h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: var(--gray-400);
      max-width: 400px;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    /* Chat messages */
    .message {
      display: flex;
      gap: 12px;
      max-width: 85%;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message--user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message--assistant {
      align-self: flex-start;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message--user .message-avatar {
      background: var(--gray-600);
    }

    .message--assistant .message-avatar {
      background: var(--gradient);
    }

    .message-content {
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      line-height: 1.6;
    }

    .message--user .message-content {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message--assistant .message-content {
      background: var(--dark-surface);
      border: 1px solid rgba(255,255,255,0.08);
      border-bottom-left-radius: 4px;
    }

    .message-text {
      font-size: 0.9375rem;
    }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 0;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--gray-400);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-4px);
        opacity: 1;
      }
    }

    /* ========================================
       SIDE PANEL (Lesson Plan + Recommendations)
       ======================================== */
    .side-panel {
      display: flex;
      flex-direction: column;
      background: var(--dark-surface);
      overflow: hidden;
    }

    .side-panel-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      flex-shrink: 0;
    }

    .side-panel-tab {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--gray-400);
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .side-panel-tab:hover {
      color: var(--light);
      background: rgba(255,255,255,0.02);
    }

    .side-panel-tab.active {
      color: var(--light);
    }

    .side-panel-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .side-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ========================================
       LESSON PLAN DISPLAY
       ======================================== */
    .lesson-plan {
      animation: fadeInUp 0.3s ease;
    }

    .lesson-plan-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .kd-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(37, 99, 235, 0.15);
      border: 1px solid rgba(37, 99, 235, 0.3);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary-light);
    }

    .kd-badge-icon {
      width: 14px;
      height: 14px;
    }

    .lesson-plan-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: var(--gray-300);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .action-btn:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.2);
    }

    .action-btn--primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .action-btn--primary:hover {
      background: var(--primary-dark);
    }

    .action-btn--download {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.3);
      color: var(--success);
    }

    .action-btn--download:hover {
      background: rgba(34, 197, 94, 0.25);
      border-color: var(--success);
    }

    /* Collapsible sections */
    .plan-section {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
    }

    .plan-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .plan-section-header:hover {
      background: rgba(255,255,255,0.02);
    }

    .plan-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .plan-section-icon {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .plan-section-toggle {
      width: 20px;
      height: 20px;
      color: var(--gray-400);
      transition: transform 0.2s;
    }

    .plan-section.open .plan-section-toggle {
      transform: rotate(180deg);
    }

    .plan-section-content {
      padding: 0 16px 16px;
      display: none;
    }

    .plan-section.open .plan-section-content {
      display: block;
    }

    /* Quick Start section */
    .quick-start {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      border-color: rgba(37, 99, 235, 0.2);
    }

    .quick-start-oneliner {
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .time-allocation {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .time-block {
      flex: 1;
      padding: 8px 12px;
      background: rgba(0,0,0,0.2);
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .time-block-label {
      font-size: 0.6875rem;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .time-block-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .key-concepts {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .concept-tag {
      padding: 4px 10px;
      background: rgba(255,255,255,0.08);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      color: var(--gray-300);
    }

    /* Teacher Script */
    .script-item {
      display: grid;
      grid-template-columns: 60px 80px 1fr;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.8125rem;
    }

    .script-item:last-child {
      border-bottom: none;
    }

    .script-time {
      color: var(--accent);
      font-weight: 500;
    }

    .script-phase {
      color: var(--gray-400);
    }

    .script-content {
      color: var(--gray-200);
      line-height: 1.5;
    }

    /* Discussion Questions */
    .question-item {
      padding: 12px;
      background: rgba(0,0,0,0.15);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .question-item:last-child {
      margin-bottom: 0;
    }

    .question-text {
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .question-answers {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    /* Group Work */
    .group-work-title {
      font-size: 0.9375rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .group-work-duration {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(245, 158, 11, 0.15);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .group-work-steps {
      list-style: none;
      counter-reset: step;
    }

    .group-work-steps li {
      counter-increment: step;
      display: flex;
      gap: 10px;
      padding: 8px 0;
      font-size: 0.8125rem;
      color: var(--gray-300);
    }

    .group-work-steps li::before {
      content: counter(step);
      width: 20px;
      height: 20px;
      background: var(--dark-elevated);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6875rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    /* KD-Check Section */
    .kd-check-section {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(16, 185, 129, 0.08) 100%);
      border-color: rgba(34, 197, 94, 0.2);
    }

    .kd-check-section .plan-section-icon {
      color: var(--success);
    }

    .kd-check-intro {
      font-size: 0.8125rem;
      color: var(--gray-400);
      margin-bottom: 12px;
    }

    .kd-check-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kd-check-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.8125rem;
    }

    .kd-check-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      flex-shrink: 0;
      background: rgba(255,255,255,0.05);
      color: var(--gray-500);
    }

    .kd-check-icon.checked {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .kd-check-text {
      color: var(--gray-300);
      line-height: 1.4;
    }

    .kd-check-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .kd-check-score {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--success);
    }

    .kd-check-btn {
      padding: 6px 12px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: var(--radius-md);
      color: var(--success);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .kd-check-btn:hover {
      background: rgba(34, 197, 94, 0.25);
    }

    /* ========================================
       RECOMMENDATIONS PANEL
       ======================================== */
    .recommendations-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .recommendation-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      padding: 12px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .recommendation-card:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.12);
    }

    .recommendation-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .recommendation-title {
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.4;
    }

    .recommendation-score {
      padding: 2px 8px;
      background: rgba(34, 197, 94, 0.15);
      border-radius: var(--radius-full);
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--success);
      flex-shrink: 0;
    }

    .recommendation-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .file-badge {
      padding: 2px 8px;
      background: rgba(255,255,255,0.08);
      border-radius: var(--radius-sm);
      font-size: 0.6875rem;
      color: var(--gray-400);
    }

    .recommendation-snippet {
      font-size: 0.75rem;
      color: var(--gray-400);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .recommendation-action {
      margin-top: 10px;
    }

    .use-btn {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(37, 99, 235, 0.3);
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-light);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .use-btn:hover {
      background: rgba(37, 99, 235, 0.2);
      border-color: var(--primary);
    }

    /* ========================================
       CITATIONS PANEL
       ======================================== */
    .citations-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .citation-item {
      padding: 10px 12px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
    }

    .citation-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .citation-source {
      font-weight: 500;
      color: var(--gray-300);
    }

    .citation-sim {
      color: var(--gray-500);
    }

    .citation-text {
      color: var(--gray-400);
      line-height: 1.5;
    }

    /* ========================================
       INPUT AREA
       ======================================== */
    .input-area {
      padding: 16px 24px 24px;
      background: var(--dark-surface);
      border-top: 1px solid rgba(255,255,255,0.08);
      flex-shrink: 0;
    }

    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .suggestion-chip {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 8px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      color: var(--gray-300);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .suggestion-chip:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
      color: var(--light);
    }

    .chip-subtitle {
      font-size: 0.7rem;
      color: var(--gray-500);
      font-weight: 400;
      margin-top: 2px;
    }

    .suggestion-chip:hover .chip-subtitle {
      color: var(--gray-400);
    }

    .input-row {
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 14px 18px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius-lg);
      color: var(--light);
      font-size: 0.9375rem;
      font-family: inherit;
      outline: none;
      transition: all 0.2s;
    }

    .chat-input::placeholder {
      color: var(--gray-500);
    }

    .chat-input:focus {
      border-color: var(--primary);
      background: rgba(0,0,0,0.4);
    }

    .send-btn {
      padding: 14px 24px;
      background: var(--primary);
      border: none;
      border-radius: var(--radius-lg);
      color: white;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .send-btn:hover {
      background: var(--primary-dark);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-btn-icon {
      width: 18px;
      height: 18px;
    }

    /* Loading state */
    .send-btn.loading .send-btn-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ========================================
       EMPTY PANELS
       ======================================== */
    .panel-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: var(--gray-500);
    }

    .panel-empty-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .panel-empty p {
      font-size: 0.8125rem;
      line-height: 1.5;
    }

    /* ========================================
       PRINT STYLES
       ======================================== */
    @media print {
      body {
        background: white;
        color: black;
      }

      .header,
      .input-area,
      .side-panel-tabs,
      .chat-panel,
      .action-btn,
      .suggestion-chips {
        display: none !important;
      }

      .side-panel {
        width: 100%;
        max-width: 100%;
      }

      .plan-section {
        background: white;
        border: 1px solid #ddd;
      }

      .plan-section-content {
        display: block !important;
      }

      .kd-badge {
        background: #e0e7ff;
        border-color: #a5b4fc;
        color: #3730a3;
      }
    }

    /* ========================================
       UTILITIES
       ======================================== */
    .hidden {
      display: none !important;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    /* ========================================
       TOAST NOTIFICATIONS
       ======================================== */
    .toast-container {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      padding: 12px 20px;
      background: var(--dark-elevated);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      color: var(--light);
      font-size: 0.875rem;
      box-shadow: var(--shadow-lg);
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
      display: flex;
      align-items: center;
      gap: 8px;
      pointer-events: auto;
    }

    .toast--success {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.15);
    }

    .toast--info {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.15);
    }

    .toast--warning {
      border-color: var(--warning);
      background: rgba(245, 158, 11, 0.15);
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes toastOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* ========================================
       MODAL
       ======================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--dark-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-lg);
      padding: 24px;
      max-width: 400px;
      width: 90%;
      transform: scale(0.95);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-text {
      color: var(--gray-400);
      font-size: 0.875rem;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn--secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--gray-300);
    }

    .modal-btn--secondary:hover {
      background: rgba(255,255,255,0.05);
    }

    .modal-btn--primary {
      background: var(--primary);
      border: none;
      color: white;
    }

    .modal-btn--primary:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body data-route="/teacher/teachergpt/chat">
  <div class="app-container">
    <!-- ========================================
         HEADER
         ======================================== -->
    <header class="header">
      <div class="header-brand">
        <div class="header-logo">eX</div>
        <div>
          <div class="header-title">e-Xpert SAM</div>
          <div class="header-subtitle">Je lesplan in 1 klik</div>
        </div>
      </div>

      <div class="header-controls">
        <div class="scope-toggle">
          <button class="scope-btn active" data-scope="all" data-cta-id="cta-scope-all">Alles</button>
          <button class="scope-btn" data-scope="materials" data-cta-id="cta-scope-materials">Materialen</button>
          <button class="scope-btn" data-scope="mes" data-cta-id="cta-scope-mes">MES</button>
        </div>
        <button class="clear-btn" data-cta-id="cta-teachergpt-chat-clear" data-action="click" onclick="clearChat()">
          Wissen
        </button>
        <button class="settings-btn" id="settingsBtn" data-cta-id="cta-settings-toggle" onclick="toggleSettings()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Settings Panel (collapsible) -->
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-grid">
        <div class="settings-field">
          <label class="settings-label" for="scopeSelect">Zoekomvang</label>
          <select class="settings-select" id="scopeSelect" data-cta-id="cta-teachergpt-scope" onchange="handleScopeChange(this.value)">
            <option value="all" selected>Alles (Materialen + MES)</option>
            <option value="materials">Alleen Materialen</option>
            <option value="mes">Alleen MES</option>
          </select>
        </div>

        <div class="settings-field">
          <label class="settings-label" for="materialSelect">Materiaal (optioneel)</label>
          <div class="settings-row">
            <select class="settings-select" id="materialSelect" data-cta-id="cta-teachergpt-material" onchange="handleMaterialChange(this.value)">
              <option value="">(Alle materialen)</option>
              <option value="mat-1">Casus Mw. Jansen ‚Äì zorgplan bijstellen</option>
              <option value="mat-2">Werkblad zorgdoelen bijstellen</option>
              <option value="mat-3">Checklist zorginterventies veilig uitvoeren</option>
              <option value="mat-abcde-1">ABCDE-checklist acute situaties</option>
              <option value="mat-sbar-1">SBAR-template overdracht</option>
              <option value="mat-refl-1">STARR-reflectie werkblad</option>
            </select>
            <button class="refresh-btn" id="refreshMaterialsBtn" data-cta-id="cta-refresh-materials" onclick="refreshMaterials()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
              </svg>
              Refresh
            </button>
          </div>
          <div class="selected-material" id="selectedMaterialInfo"></div>
        </div>
      </div>
    </div>

    <!-- Error Alert (hidden by default) -->
    <div class="error-alert hidden" id="errorAlert">
      <svg class="error-alert-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <div class="error-alert-content">
        <div class="error-alert-title">Fout</div>
        <div class="error-alert-text" id="errorAlertText">Er is iets misgegaan. Probeer het opnieuw.</div>
      </div>
      <button class="error-alert-close" onclick="hideError()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- ========================================
         MAIN CONTENT
         ======================================== -->
    <main class="main-content">
      <!-- Chat Panel -->
      <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
          <!-- Empty State (shown initially) -->
          <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">üí°</div>
            <h2>Welkom bij e-Xpert SAM</h2>
            <p>
              Vertel wat je wilt bereiken met je les, en ik maak een compleet lesplan voor je.
              De KD-aansluiting regel ik automatisch. Kies een onderwerp hieronder of typ je eigen vraag.
            </p>
          </div>

          <!-- Messages will be inserted here -->
        </div>

        <!-- Input Area -->
        <div class="input-area">
          <div class="suggestion-chips" id="suggestionChips">
            <!-- All 5 workshop KD codes covered - goal-oriented labels -->
            <button class="suggestion-chip" data-cta-id="cta-suggestion-1" title="KD B1-K1-W2" onclick="useSuggestion('Hoe leer ik studenten een zorgplan bijstellen als de situatie verandert?')">
              üìã Zorgplan bijstellen
              <span class="chip-subtitle">Als de situatie verandert</span>
            </button>
            <button class="suggestion-chip" data-cta-id="cta-suggestion-2" title="KD B1-K1-W3" onclick="useSuggestion('Maak een les over het veilig uitvoeren van zorghandelingen met aandacht voor eigen regie')">
              ü©∫ Zorghandelingen uitvoeren
              <span class="chip-subtitle">Veilig en met eigen regie</span>
            </button>
            <button class="suggestion-chip" data-cta-id="cta-suggestion-3" title="KD B1-K1-W5" onclick="useSuggestion('Hoe leer ik studenten een noodsituatie herkennen en adequaat handelen?')">
              üö® Noodsituaties herkennen
              <span class="chip-subtitle">ABCDE-methodiek</span>
            </button>
            <button class="suggestion-chip" data-cta-id="cta-suggestion-4" title="KD B1-K2-W2" onclick="useSuggestion('Maak een les over samenwerken in het team en goede overdracht')">
              ü§ù Samenwerken in het team
              <span class="chip-subtitle">SBAR-communicatie</span>
            </button>
            <button class="suggestion-chip" data-cta-id="cta-suggestion-5" title="KD B1-K3-W2" onclick="useSuggestion('Hoe leer ik studenten reflecteren op hun praktijkervaringen?')">
              üéØ Reflecteren op je werk
              <span class="chip-subtitle">STARR-methode</span>
            </button>
          </div>

          <div class="input-row">
            <input 
              type="text" 
              class="chat-input" 
              id="chatInput"
              placeholder="Wat wil je je studenten leren? bijv. 'Hoe herkennen ze een noodsituatie?'"
              data-cta-id="cta-teachergpt-chat-input"
              data-action="edit"
              onkeydown="handleInputKeydown(event)"
            />
            <button class="send-btn" id="sendBtn" data-cta-id="cta-teachergpt-chat-send" data-action="click" onclick="sendMessage()">
              <span>Verstuur</span>
              <svg class="send-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="side-panel">
        <div class="side-panel-tabs">
          <button class="side-panel-tab active" data-tab="lesplan" onclick="switchTab('lesplan')">
            Lesplan
          </button>
          <button class="side-panel-tab" data-tab="materials" onclick="switchTab('materials')">
            Materialen
          </button>
          <button class="side-panel-tab" data-tab="sources" onclick="switchTab('sources')">
            Bronnen
          </button>
        </div>

        <div class="side-panel-content">
          <!-- Lesson Plan Tab -->
          <div class="tab-content active" id="tab-lesplan">
            <div class="panel-empty" id="lesplanEmpty">
              <svg class="panel-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p>Vraag om een lesplan en het verschijnt hier met alle details.</p>
            </div>

            <!-- Lesson Plan Content (hidden initially) -->
            <div class="lesson-plan hidden" id="lesplanContent">
              <!-- Content inserted by JS -->
            </div>
          </div>

          <!-- Materials Tab -->
          <div class="tab-content" id="tab-materials">
            <div class="panel-empty" id="materialsEmpty">
              <svg class="panel-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
              </svg>
              <p>Relevante materialen verschijnen hier wanneer je een vraag stelt.</p>
            </div>

            <!-- Recommendations Grid (hidden initially) -->
            <div class="recommendations-grid hidden" id="materialsContent">
              <!-- Content inserted by JS -->
            </div>
          </div>

          <!-- Sources Tab -->
          <div class="tab-content" id="tab-sources">
            <div class="panel-empty" id="sourcesEmpty">
              <svg class="panel-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
              <p>Gebruikte bronnen en citaten worden hier getoond.</p>
            </div>

            <!-- Citations List (hidden initially) -->
            <div class="citations-list hidden" id="sourcesContent">
              <!-- Content inserted by JS -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-title" id="modalTitle">Lesplan opslaan</div>
      <div class="modal-text" id="modalText">Wil je dit lesplan opslaan in je bibliotheek?</div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn--secondary" onclick="closeModal()">Annuleren</button>
        <button class="modal-btn modal-btn--primary" id="modalConfirm" onclick="confirmModal()">Opslaan</button>
      </div>
    </div>
  </div>

  <!-- ========================================
       JAVASCRIPT
       ======================================== -->
  <script>
    // ========================================
    // STATE
    // ========================================
    const state = {
      messages: [],
      currentScope: 'all',
      isLoading: false,
      currentPlan: null,
      currentCitations: null,
      selectedMaterial: null,
      selectedMaterialId: '',
      modalCallback: null,
      settingsOpen: false,
      error: null,
    };

    // Mock materials data (matching real system structure)
    const mockMaterials = [
      { id: 'mat-1', title: 'Casus Mw. Jansen ‚Äì zorgplan bijstellen', file_name: 'B1-K1-W2-casus-mw-jansen.txt' },
      { id: 'mat-2', title: 'Werkblad zorgdoelen bijstellen', file_name: 'B1-K1-W2-werkblad-zorgdoelen.txt' },
      { id: 'mat-3', title: 'Checklist zorginterventies veilig uitvoeren', file_name: 'B1-K1-W3-checklist-zorginterventies.txt' },
      { id: 'mat-abcde-1', title: 'ABCDE-checklist acute situaties', file_name: 'B1-K1-W5-abcde-checklist.txt' },
      { id: 'mat-sbar-1', title: 'SBAR-template overdracht', file_name: 'B1-K2-W2-sbar-template.txt' },
      { id: 'mat-refl-1', title: 'STARR-reflectie werkblad', file_name: 'B1-K3-W2-starr-werkblad.txt' },
    ];

    // ========================================
    // DEMO DATA
    // ========================================
    const demoLessonPlan = {
      kdAlignment: {
        code: "B1-K1-W2",
        title: "Stelt het zorgplan op en/of bij"
      },
      quickStart: {
        oneLiner: "Studenten leren signalen te herkennen die wijzen op noodzakelijke aanpassingen in het zorgplan en formuleren zelfstandig bijstellingen.",
        timeAllocation: {
          start: 10,
          kern: 30,
          afsluiting: 10
        },
        keyConcepts: ["Klinisch redeneren", "Observatie", "Zorgdoelen", "Rapportage", "Eigen regie"]
      },
      teacherScript: [
        { time: "0-5 min", phase: "Start", action: "Activeer", content: "Begin met een korte casus: 'Mevrouw Jansen (78) verblijft op de geriatrieafdeling. Gisteren liep ze nog zelfstandig met rollator naar het toilet. Vandaag lukt dit niet meer - ze is kortademig en haar benen zijn dik. Wat doe je?' Laat studenten in duo's 2 minuten brainstormen. Vraag: 'Wat valt jullie op? Welke signalen zijn nieuw?'" },
        { time: "5-10 min", phase: "Start", action: "Verbind", content: "Koppel de antwoorden aan het KD: 'Dit gaat over B1-K1-W2 - het bijstellen van zorgplannen wanneer de situatie verandert. Als verpleegkundige signaleer je veranderingen en pas je het zorgplan aan.' Leg uit: 'Een zorgplan is geen statisch document - het leeft mee met de zorgvrager. Veranderingen MOETEN worden vastgelegd.'" },
        { time: "10-18 min", phase: "Kern", action: "Klinisch redeneren", content: "Introduceer de cyclus van klinisch redeneren:\n\n1) SIGNALEREN: 'Wat zie, hoor, ruik, voel je? Wat vertelt de zorgvrager?' Bij mw. Jansen: kortademigheid, dikke benen, minder mobiel, slaapt slecht.\n\n2) ANALYSEREN: 'Wat zou de oorzaak kunnen zijn? Welke verbanden zie je?' Bij mw. Jansen: hartfalen verergerd? Vochtophoping? Medicatie-effect?\n\n3) CONCLUDEREN: 'Wat is je werkhypothese?' Bij mw. Jansen: waarschijnlijk verslechtering hartfalen, arts inschakelen.\n\n4) PLANNEN: 'Welke acties ga je ondernemen?' Doelen aanpassen, interventies wijzigen, afstemmen.\n\n5) EVALUEREN: 'Werkt het plan? Moet er opnieuw worden bijgesteld?'" },
        { time: "18-28 min", phase: "Kern", action: "SMART doelen", content: "Leg SMART uit - dit is de standaard voor het formuleren van zorgdoelen:\n\nS = SPECIFIEK: Het doel moet concreet en duidelijk zijn.\nNiet: 'Mevrouw moet beter kunnen lopen'\nWel: 'Mevrouw loopt zelfstandig met rollator naar het toilet (10 meter)'\n\nM = MEETBAAR: Je moet kunnen vaststellen of het doel behaald is.\nNiet: 'Mevrouw heeft minder pijn'\nWel: 'Mevrouw geeft pijn aan als VAS-score 3 of lager (nu: 7)'\n\nA = ACCEPTABEL: Het doel moet passen bij de wensen van de zorgvrager.\nVraag: 'Wat vindt mevrouw zelf belangrijk?' 'Ik wil graag naar mijn bridgeclub'\n‚Üí Doel: 'Mevrouw kan over 2 weken 1 uur zitten zonder klachten'\n\nR = REALISTISCH: Het doel moet haalbaar zijn gezien de situatie.\nNiet: 'Mevrouw loopt na 1 week weer normaal' (bij hartfalen)\nWel: 'Mevrouw kan met hulp transfers maken naar de stoel'\n\nT = TIJDGEBONDEN: Wanneer evalueer je het doel?\nNiet: 'Mevrouw kan weer traplopen'\nWel: 'Over 2 weken kan mevrouw met steun de trap af'" },
        { time: "28-40 min", phase: "Kern", action: "Oefenen", content: "Studenten werken in groepjes van 3 aan de uitgebreide casus Mw. Jansen. Opdracht:\n1) Lees de volledige casus (uitgedeeld werkblad)\n2) Identificeer 3 signalen die wijzen op verandering\n3) Analyseer: wat zou de oorzaak kunnen zijn?\n4) Formuleer 2 nieuwe SMART-doelen (let op alle 5 criteria!)\n5) Bedenk 2 vragen die je aan mevrouw Jansen zou stellen (eigen regie!)\n\nLoop rond en check: zijn de doelen echt SMART? Wordt de zorgvrager betrokken?" },
        { time: "40-45 min", phase: "Afsluiting", action: "Presentaties", content: "Elke groep presenteert 1 SMART-doel. Laat de klas checken: is het Specifiek? Meetbaar? Acceptabel? Realistisch? Tijdgebonden? Geef directe feedback. Veelgemaakte fouten: te vaag, niet meetbaar, geen tijdsperiode, niet besproken met zorgvrager." },
        { time: "45-50 min", phase: "Afsluiting", action: "Reflectie", content: "Vraag: 'Wat vond je lastig aan het formuleren van SMART-doelen? Wat neem je mee naar de praktijk?' Sluit af met de boodschap: 'Een goed zorgplan is de basis voor goede zorg. Als je signaleert dat de situatie verandert, MOET je het plan bijstellen. Niet bijstellen is geen optie!' Vooruitblik: volgende les gaan we dieper in op de evaluatiecyclus." }
      ],
      discussionQuestions: [
        { question: "Wanneer besluit je dat een zorgplan moet worden bijgesteld?", expectedAnswers: ["Bij elke verandering in de toestand van de zorgvrager (verbetering of verslechtering)", "Na een gepland evaluatiemoment (bijv. elke week)", "Op verzoek van de zorgvrager of diens naasten", "Als doelen zijn behaald en er nieuwe doelen nodig zijn", "Als interventies niet het gewenste effect hebben", "Bij nieuwe diagnoses of behandelingen"] },
        { question: "Hoe betrek je de zorgvrager bij het bijstellen van doelen (eigen regie)?", expectedAnswers: ["Vraag wat de zorgvrager zelf belangrijk vindt: 'Waar wilt u naartoe werken?'", "Leg opties uit in begrijpelijke taal, geen vaktermen", "Laat de zorgvrager prioriteiten bepalen: 'Wat vindt u het belangrijkst?'", "Check of de zorgvrager het eens is met het doel", "Respecteer keuzes, ook als ze niet overeenkomen met jouw advies", "Documenteer de wensen en keuzes van de zorgvrager"] },
        { question: "Wat doe je als de zorgvrager het niet eens is met jouw voorstel?", expectedAnswers: ["Luister naar de bezwaren: 'Wat maakt dat u dit niet wilt?'", "Probeer de achterliggende reden te begrijpen", "Bied alternatieven aan waar mogelijk", "Leg de consequenties uit van niet-behandelen (zonder te dreigen)", "Respecteer uiteindelijk de autonomie van de zorgvrager", "Documenteer het gesprek en de keuze", "Schakel zo nodig collega's of arts in bij complexe situaties"] }
      ],
      groupWork: {
        title: "Casus Mw. Jansen - Zorgplan bijstellen met SMART-doelen",
        durationMinutes: 15,
        steps: [
          "Lees de volledige casus: Mw. Jansen (78), geriatrieafdeling, hartfalen. Gisteren: liep zelfstandig met rollator. Vandaag: kortademig in rust, dikke benen (oedeem ++), slaapt slecht door benauwdheid, bloeddruk 95/60, gewicht +2kg in 2 dagen.",
          "Signaleer: Markeer 3 signalen die wijzen op verandering. Bespreek: zijn dit nieuwe signalen? Hoe urgent is het?",
          "Analyseer: Wat zou de oorzaak kunnen zijn? (Hint: vochtophoping, verslechtering hartfalen, medicatie?) Welke informatie heb je nog nodig?",
          "Formuleer 2 SMART-doelen. Check elk criterium! Voorbeeld: 'Over 3 dagen is het oedeem in de benen verminderd van ++ naar +, gemeten door omtrek enkels' (Specifiek, Meetbaar, haalbaar/Acceptabel, Realistisch, Tijdgebonden).",
          "Bedenk 2 vragen voor het gesprek met mw. Jansen: hoe betrek je haar bij de aanpassingen? Voorbeeld: 'Wat merkt u zelf van de verandering?' 'Wat vindt u het belangrijkst om weer te kunnen?'",
          "Bereid een korte presentatie voor: presenteer 1 SMART-doel en leg uit waarom het aan alle criteria voldoet."
        ]
      },
      // Detailed content for teacher handbook
      detailedContent: {
        SMART: {
          S: {
            title: "Specifiek",
            explanation: "Het doel moet concreet en duidelijk zijn. Iedereen moet hetzelfde begrijpen.",
            wrongExample: "Mevrouw moet beter kunnen lopen",
            correctExample: "Mevrouw loopt zelfstandig met rollator naar het toilet (10 meter)",
            checkQuestion: "Is voor iedereen duidelijk wat er bereikt moet worden?"
          },
          M: {
            title: "Meetbaar",
            explanation: "Je moet kunnen vaststellen of het doel behaald is. Gebruik cijfers, schalen of concrete observaties.",
            wrongExample: "Mevrouw heeft minder pijn",
            correctExample: "Mevrouw geeft pijn aan als VAS-score 3 of lager (nu: 7)",
            checkQuestion: "Hoe kun je meten of het doel behaald is?"
          },
          A: {
            title: "Acceptabel",
            explanation: "Het doel moet passen bij de wensen en waarden van de zorgvrager. Dit is de kern van eigen regie!",
            wrongExample: "Mevrouw moet elke dag oefeningen doen (zonder dat ze dit wil)",
            correctExample: "Mevrouw wil graag naar bridgeclub ‚Üí Doel: over 2 weken 1 uur zitten zonder klachten",
            checkQuestion: "Vindt de zorgvrager dit doel belangrijk? Heb je het gevraagd?"
          },
          R: {
            title: "Realistisch",
            explanation: "Het doel moet haalbaar zijn gezien de situatie, diagnose en mogelijkheden.",
            wrongExample: "Mevrouw loopt na 1 week weer normaal (bij ernstig hartfalen)",
            correctExample: "Mevrouw kan met hulp van 1 persoon transfers maken naar de stoel",
            checkQuestion: "Is dit doel haalbaar gezien de huidige situatie?"
          },
          T: {
            title: "Tijdgebonden",
            explanation: "Wanneer evalueer je of het doel behaald is? Geef een concrete datum of periode.",
            wrongExample: "Mevrouw kan weer traplopen",
            correctExample: "Over 2 weken kan mevrouw met steun van 1 persoon de trap af naar de huiskamer",
            checkQuestion: "Wanneer evalueer je dit doel?"
          }
        },
        klinischRedeneren: {
          stappen: [
            { stap: "Signaleren", beschrijving: "Wat neem je waar? Wat zie, hoor, ruik, voel je? Wat vertelt de zorgvrager?", voorbeeld: "Kortademigheid, dikke benen, minder mobiel, slaapt slecht" },
            { stap: "Analyseren", beschrijving: "Wat zou de oorzaak kunnen zijn? Welke verbanden zie je? Welke informatie heb je nog nodig?", voorbeeld: "Hartfalen verergerd? Vochtophoping? Medicatie-effect?" },
            { stap: "Concluderen", beschrijving: "Wat is je werkhypothese? Wat denk je dat er aan de hand is?", voorbeeld: "Waarschijnlijk verslechtering hartfalen, arts inschakelen" },
            { stap: "Plannen", beschrijving: "Welke acties ga je ondernemen? Doelen aanpassen, interventies wijzigen, afstemmen", voorbeeld: "Vochtbeperking, dagelijks wegen, diuretica op voorschrift" },
            { stap: "Evalueren", beschrijving: "Werkt het plan? Verbetering of verslechtering? Moet er opnieuw worden bijgesteld?", voorbeeld: "Na 3 dagen: oedeem verminderd, doorgaan met plan" }
          ]
        }
      }
    };

    const demoRecommendations = [
      {
        id: "mat-1",
        title: "Casus Mw. Jansen ‚Äì zorgplan bijstellen (B1-K1-W2)",
        fileName: "B1-K1-W2-casus-mw-jansen.txt",
        contentType: "Casus",
        score: 0.654,
        snippet: "Mevrouw Jansen (78) verblijft op de geriatrieafdeling. Sinds 2 dagen is ze benauwd, heeft oedeem in de benen en slaapt slecht..."
      },
      {
        id: "mat-2",
        title: "Werkblad zorgdoelen bijstellen (B1-K1-W2)",
        fileName: "B1-K1-W2-werkblad-zorgdoelen.txt",
        contentType: "Werkblad",
        score: 0.652,
        snippet: "Stap 1 ‚Äì Huidige situatie: Wat is de actuele zorgvraag? Welke signalen zijn nieuw? Stap 2 ‚Äì Doelen: Welk doel is niet meer haalbaar?..."
      },
      {
        id: "mat-3",
        title: "Checklist zorginterventies veilig uitvoeren (B1-K1-W3)",
        fileName: "B1-K1-W3-checklist-zorginterventies.txt",
        contentType: "Checklist",
        score: 0.565,
        snippet: "Checklist (praktijk): 1) Controleer zorgplan en afspraken. 2) Leg de interventie uit aan de zorgvrager (eigen regie)..."
      }
    ];

    // Citations format matches real system: { source: "material"|"mes", course_id, item_index, similarity, text }
    const demoCitations = [
      { source: "mes", course_id: "mes:kd2026-vig-vp", item_index: 2, similarity: 0.89, text: "De beginnend beroepsbeoefenaar stelt het zorgplan op en/of bij. Dit omvat het formuleren van zorgdoelen..." },
      { source: "material", course_id: "material:a4cf045c", item_index: 0, similarity: 0.65, text: "Mevrouw Jansen (78) verblijft op de geriatrieafdeling. Situatie: Sinds 2 dagen is ze benauwd..." },
      { source: "material", course_id: "material:7d021336", item_index: 1, similarity: 0.62, text: "Werkblad: Zorgdoelen bijstellen. Stap 1 ‚Äì Huidige situatie: Wat is de actuele zorgvraag?..." }
    ];

    // Additional demo data for ABCDE query
    const demoABCDE = {
      lessonPlan: {
        kdAlignment: { code: "B1-K1-W5", title: "Handelt in onvoorziene en/of acute situaties" },
        quickStart: {
          oneLiner: "Studenten leren de ABCDE-methodiek systematisch toe te passen bij acute situaties en adequaat te alarmeren.",
          timeAllocation: { start: 10, kern: 35, afsluiting: 5 },
          keyConcepts: ["ABCDE-methodiek", "Alarmprocedure", "Klinische blik", "SBAR-communicatie", "Veiligheid"]
        },
        teacherScript: [
          { time: "0-5 min", phase: "Start", action: "Activeer", content: "Toon een korte video of beschrijf een acute situatie: 'Een bewoner wordt plotseling benauwd en grijpt naar zijn keel.' Vraag: 'Wat doe je als eerste? Waar begin je?' Laat studenten in duo's 1 minuut brainstormen." },
          { time: "5-10 min", phase: "Start", action: "Verbind", content: "Introduceer ABCDE als geheugensteun: 'ABCDE is een systematische aanpak die je helpt om in stressvolle situaties niets te vergeten. Je werkt ALTIJD in deze volgorde omdat je eerst de meest levensbedreigende problemen aanpakt.' Link naar KD B1-K1-W5: handelen in acute situaties." },
          { time: "10-18 min", phase: "Kern", action: "Instructie A+B", content: "A = AIRWAY (Luchtweg): 'De A staat voor Airway. Hier check je of lucht vrij door de grote luchtwegen kan stromen.' Oorzaken obstructie: teruggevallen tong (bewusteloze), vreemd voorwerp (verslikking), zwelling (anafylaxie), bloeding/braaksel. Observeer: kan pati√´nt praten? (vrije luchtweg = kan praten), stridor/snurken?, thoraxbewegingen zonder lucht? Acties: kinlift, stabiele zijligging, uitzuigen. B = BREATHING (Ademhaling): 'Bij de B beoordeel je of de zuurstofuitwisseling goed verloopt.' Oorzaken: astma/COPD, pneumonie, longembolie, hartfalen. Meet: ademfrequentie (12-20/min normaal), saturatie (>94%), ademarbeid, cyanose. Acties: rechtop zetten, zuurstof geven." },
          { time: "18-26 min", phase: "Kern", action: "Instructie C+D", content: "C = CIRCULATION (Bloedsomloop): 'Bij de C check je of het hart voldoende bloed rondpompt.' Oorzaken: bloedverlies, dehydratie, sepsis, hartinfarct, shock. Meet: hartfrequentie (60-100/min), bloeddruk (>100 systolisch), capillaire refill (<2 sec), huidkleur (bleek/grauw?), bewustzijn. Acties: Trendelenburg bij shock, infuus, bloeding stelpen. D = DISABILITY (Neurologisch): 'De D gaat over de hersenfunctie.' Oorzaken: hypoglykemie, CVA, epilepsie, intoxicatie, hypoxie. Meet: AVPU-score (Alert/Verbal/Pain/Unresponsive), pupillen, glucose. Acties: glucose bij hypo, stabiele zijligging bij insult." },
          { time: "26-30 min", phase: "Kern", action: "Instructie E", content: "E = EXPOSURE (Volledig onderzoek): 'Tot slot ontkleed je de pati√´nt volledig om niets te missen.' Wat doe je: volledig ontkleden (privacy!), van top tot teen inspecteren, temperatuur meten. Let op: huiduitslag (petechie√´n bij sepsis), zwellingen, wonden. BELANGRIJK: hypothermie voorkomen - dek pati√´nt weer toe! Waardigheid respecteren." },
          { time: "30-45 min", phase: "Kern", action: "Simulatie", content: "Studenten oefenen in 3-tallen. Scenario: 'Mevrouw De Vries (68) krijgt een allergische reactie na antibiotica. Ze heeft rode vlekken, is benauwd en voelt zich duizelig.' Rollen: 1) Verpleegkundige (past ABCDE toe), 2) Pati√´nt (speelt symptomen), 3) Observator (checkt met ABCDE-kaart). Na 5 min wisselen. Observator let op: systematisch werken, hardop denken, juiste volgorde." },
          { time: "45-50 min", phase: "Afsluiting", action: "Reflectie", content: "Nabespreking in de groep: 'Wat ging goed? Wat was lastig?' Bespreek veelgemaakte fouten: stappen overslaan, te snel naar behandeling gaan. Herhaal de alarmprocedure: 'Bij welke bevindingen bel je direct 112? Bij bewusteloosheid, geen ademhaling, geen pols, ernstige benauwdheid, shock.' Sluit af: 'ABCDE wordt automatisme door veel te oefenen.'" }
        ],
        discussionQuestions: [
          { question: "Waarom is de volgorde ABCDE zo belangrijk?", expectedAnswers: ["Je pakt eerst de meest levensbedreigende problemen aan", "Systematische aanpak voorkomt dat je iets vergeet", "A-problemen zijn dodelijker dan B-problemen, B dodelijker dan C, etc.", "Onder stress ga je vanzelf terug naar de structuur"] },
          { question: "Wanneer schakel je hulp in en hoe communiceer je dan?", expectedAnswers: ["Bij twijfel: ALTIJD hulp inschakelen", "Bij verslechtering ondanks je interventies", "Bij afwijkende vitale functies buiten normaalwaarden", "Gebruik SBAR voor duidelijke overdracht: Situatie-Background-Assessment-Recommendation"] },
          { question: "Wat zijn de normaalwaarden die je moet kennen?", expectedAnswers: ["Ademfrequentie: 12-20 per minuut", "Saturatie: boven 94%", "Hartfrequentie: 60-100 per minuut", "Bloeddruk: boven 100 systolisch", "Capillaire refill: onder 2 seconden", "AVPU: Alert is normaal"] }
        ],
        groupWork: {
          title: "Simulatie: Allergische reactie na medicatie",
          durationMinutes: 15,
          steps: [
            "Verdeel rollen: verpleegkundige (handelt), pati√´nt (speelt symptomen), observator (checkt ABCDE-kaart)",
            "Lees het scenario: 'Mw. De Vries (68) krijgt antibiotica IV. Na 5 minuten: rode vlekken op romp, jeuk, benauwdheid, duizeligheid.'",
            "Verpleegkundige past ABCDE toe en denkt HARDOP: 'Ik begin bij A, de luchtweg...'",
            "Pati√´nt reageert realistisch: bij A 'Ik kan nog praten maar het voelt dik', bij B 'Ik ben zo benauwd'",
            "Observator noteert: werd de juiste volgorde gevolgd? Werd niets overgeslagen? Was er duidelijke communicatie?",
            "Formuleer samen een SBAR-melding voor de arts",
            "Wissel na 5 minuten van rol zodat iedereen oefent"
          ]
        }
      },
      // Detailed content for teacher handbook
      detailedContent: {
        ABCDE: {
          A: {
            title: "Airway (Luchtweg)",
            explanation: "De A staat voor Airway - de luchtweg. Hier check je of lucht vrij door de grote luchtwegen kan stromen. Een geblokkeerde luchtweg is direct levensbedreigend.",
            causes: ["Teruggevallen tong (bij bewusteloze pati√´nt)", "Vreemd voorwerp (verslikking, tandprothese)", "Zwelling (anafylaxie, infectie, trauma)", "Bloeding of braaksel", "Laryngospasme"],
            observations: ["Kan de pati√´nt praten? (vrije luchtweg = kan praten)", "Hoor je stridor of snurken?", "Zie je thoraxbewegingen zonder lucht?", "Is er speekselvloed of moeite met slikken?"],
            actions: ["Kinlift of kaakstoot uitvoeren", "Stabiele zijligging", "Uitzuigen indien nodig", "Guedel/mayo bij bewusteloze"]
          },
          B: {
            title: "Breathing (Ademhaling)",
            explanation: "De B staat voor Breathing - ademhaling. Je beoordeelt of de zuurstofuitwisseling in de longen goed verloopt.",
            causes: ["Astma/COPD-exacerbatie", "Pneumonie (longontsteking)", "Pneumothorax (klaplong)", "Longembolie", "Hartfalen met longoedeem", "Hyperventilatie"],
            observations: ["Ademfrequentie (normaal 12-20/min)", "Saturatie (normaal >94%)", "Ademarbeid: neusvleugelen, intrekkingen?", "Cyanose (blauwe lippen/nagels)?", "Ausculteren: bijgeluiden?"],
            actions: ["Rechtop zetten", "Zuurstof geven", "Vernevelaar bij bronchospasme"]
          },
          C: {
            title: "Circulation (Bloedsomloop)",
            explanation: "De C staat voor Circulation - bloedsomloop. Je beoordeelt of het hart voldoende bloed rondpompt naar alle organen.",
            causes: ["Bloedverlies (intern/extern)", "Dehydratie", "Sepsis (bloedvergiftiging)", "Hartinfarct", "Hartritmestoornissen", "Anafylactische shock"],
            observations: ["Hartfrequentie (normaal 60-100/min)", "Bloeddruk (normaal >100 systolisch)", "Capillaire refill (<2 sec is normaal)", "Huidkleur: bleek, grauw, gevlekt?", "Huid: koud, klam?"],
            actions: ["Trendelenburg bij shock", "Infuus/vocht toedienen", "Bloeding stelpen", "Reanimatie bij circulatiestilstand"]
          },
          D: {
            title: "Disability (Neurologisch)",
            explanation: "De D staat voor Disability - neurologische status. Je beoordeelt de hersenfunctie.",
            causes: ["Hypoglykemie (lage bloedsuiker)", "CVA (beroerte)", "Epileptisch insult", "Verhoogde intracrani√´le druk", "Intoxicatie (drugs, alcohol, medicatie)", "Hypoxie (zuurstoftekort)"],
            observations: ["AVPU-score: Alert/Verbal/Pain/Unresponsive", "Pupillen: grootte, lichtreactie, symmetrie", "Glucosewaarde", "Motoriek: kan pati√´nt bewegen?"],
            actions: ["Glucose geven bij hypo", "Stabiele zijligging bij insult", "Beschermen tegen letsel"]
          },
          E: {
            title: "Exposure (Volledig onderzoek)",
            explanation: "De E staat voor Exposure - volledige ontbloting en lichamelijk onderzoek. Je zoekt naar verborgen problemen.",
            causes: ["Verborgen letsels", "Verborgen bloedingen", "Huidafwijkingen die op ernstige ziekte wijzen"],
            observations: ["Volledig ontkleden (privacy waarborgen!)", "Van top tot teen inspecteren", "Temperatuur meten", "Huiduitslag, zwellingen, wonden, oedeem"],
            actions: ["Hypothermie voorkomen (warm houden!)", "Waardigheid pati√´nt respecteren", "Systematisch werken"]
          }
        }
      },
      recommendations: [
        { id: "mat-abcde-1", title: "ABCDE-checklist acute situaties (B1-K1-W5)", fileName: "B1-K1-W5-abcde-checklist.txt", contentType: "Checklist", score: 0.726, snippet: "A ‚Äì Airway: controleer of de luchtweg vrij is. Kan pati√´nt praten? Stridor? B ‚Äì Breathing: ademfrequentie 12-20/min, saturatie >94%..." },
        { id: "mat-abcde-2", title: "Simulatiescenario allergische reactie (B1-K1-W5)", fileName: "B1-K1-W5-simulatie-allergie.txt", contentType: "Simulatie", score: 0.581, snippet: "Scenario: Mw. De Vries (68) krijgt antibiotica IV. Na 5 min: rode vlekken, jeuk, benauwdheid, duizeligheid. Rollen: verpleegkundige, pati√´nt, observator..." }
      ],
      citations: [
        { source: "mes", course_id: "mes:kd2026-vig-vp", item_index: 5, similarity: 0.92, text: "De beginnend beroepsbeoefenaar handelt in onvoorziene en/of acute situaties. Past ABCDE toe, alarmeert adequaat, communiceert via SBAR..." },
        { source: "material", course_id: "material:16026510", item_index: 0, similarity: 0.73, text: "ABCDE-checklist: A ‚Äì Airway: controleer of de luchtweg vrij is, kinlift/kaakstoot. B ‚Äì Breathing: ademfrequentie, saturatie, zuurstof geven..." }
      ]
    };

    // Demo data for samenwerking query
    const demoSamenwerking = {
      lessonPlan: {
        kdAlignment: { code: "B1-K2-W2", title: "Werkt samen met andere zorgprofessionals" },
        quickStart: {
          oneLiner: "Studenten oefenen effectieve communicatie en samenwerking in een multidisciplinair team met SBAR.",
          timeAllocation: { start: 10, kern: 30, afsluiting: 10 },
          keyConcepts: ["SBAR-communicatie", "MDO", "Rolverdeling", "Gezamenlijke besluitvorming", "Rapportage"]
        },
        teacherScript: [
          { time: "0-5 min", phase: "Start", action: "Activeer", content: "Vraag aan de klas: 'Met welke disciplines werk je samen in de praktijk? Noem er minimaal 3.' Verzamel antwoorden op bord (arts, fysiotherapeut, ergotherapeut, di√´tist, maatschappelijk werk, etc.). Vervolgvraag: 'Wat maakt samenwerking soms lastig?' Bespreek kort: verschillende verwachtingen, onduidelijke communicatie, hi√´rarchie." },
          { time: "5-10 min", phase: "Start", action: "Verbind", content: "Introduceer SBAR: 'SBAR is een communicatietool die oorspronkelijk uit de luchtvaart komt. Het zorgt voor gestructureerde, duidelijke overdracht zodat er geen misverstanden ontstaan.' Toon de SBAR-template op het bord. Link naar KD B1-K2-W2: samenwerken met andere zorgprofessionals." },
          { time: "10-18 min", phase: "Kern", action: "Instructie SBAR", content: "Leg elke letter uitgebreid uit met voorbeelden:\n\nS = SITUATION (Situatie): 'Je vertelt WIE je bent en WAT er NU aan de hand is.' Format: 'Ik ben [naam], [functie] van [afdeling]. Ik bel over [pati√´nt], kamer [nr]. Het probleem is [kort en concreet].' Voorbeeld: 'Goedemiddag, ik ben Lisa, verpleegkundige van afdeling Interne. Ik bel over meneer Jansen, kamer 12. Hij is acuut benauwd geworden.'\n\nB = BACKGROUND (Achtergrond): 'Je geeft relevante voorgeschiedenis.' Format: 'De pati√´nt is opgenomen vanwege [reden]. Relevante voorgeschiedenis: [ziekten, allergie√´n]. Huidige behandeling: [medicatie].' Voorbeeld: 'Meneer Jansen ligt hier 3 dagen met een pneumonie. Hij heeft COPD en diabetes type 2. Hij krijgt antibiotica IV en prednison.'" },
          { time: "18-25 min", phase: "Kern", action: "Instructie SBAR vervolg", content: "A = ASSESSMENT (Beoordeling): 'Je geeft jouw professionele inschatting.' Format: 'Ik heb vastgesteld: [observaties]. Vitale functies zijn: [waarden]. Ik denk dat er sprake is van [jouw analyse].' Voorbeeld: 'Zijn saturatie is nu 88% zonder zuurstof, temperatuur 39.4, ademfrequentie 28/min. Hij gebruikt hulpademhalingsspieren. Ik vermoed dat zijn pneumonie verslechtert.'\n\nR = RECOMMENDATION (Advies): 'Je vraagt concreet wat je nodig hebt.' Format: 'Ik vraag om [concrete actie]. Kunt u [specifieke vraag]? Wanneer kan ik u verwachten?' Voorbeeld: 'Ik heb hem rechtop gezet en zuurstof 3 liter gegeven. Kunt u zo snel mogelijk komen kijken? Of wilt u dat ik alvast een thoraxfoto laat maken?'\n\nLaat studenten het complete voorbeeld nazeggen." },
          { time: "25-40 min", phase: "Kern", action: "Rollenspel MDO", content: "Verdeel in groepen van 4. Rollen: (1) Verpleegkundige: kent pati√´nt het beste, doet SBAR-overdracht, (2) Arts: stelt vragen, neemt beslissing, (3) Fysiotherapeut: adviseert over mobiliteit, (4) Mantelzorger: brengt perspectief pati√´nt in. Casus: 'Mw. De Boer (75) is opgenomen na een heupoperatie. Ze wil graag naar huis maar is nog instabiel bij lopen. Zoon maakt zich zorgen.' Opdracht: Voer een MDO van 10 minuten. Verpleegkundige opent met SBAR. Maak samen een plan: wanneer naar huis? Welke hulp nodig?" },
          { time: "40-50 min", phase: "Afsluiting", action: "Nabespreking", content: "Bespreek per groep: 'Hoe ging de SBAR-overdracht? Was het duidelijk?' Vraag observaties: 'Werd iedereen gehoord? Wie nam de leiding? Hoe werd tot een besluit gekomen?' Veelgemaakte fouten: te lang verhaal bij S, mening geven bij B (hoort bij A), geen concrete vraag bij R. Sluit af: 'SBAR werkt alleen als je het echt gebruikt. Oefen in de praktijk!'" }
        ],
        discussionQuestions: [
          { question: "Wat maakt SBAR zo effectief als communicatiemiddel?", expectedAnswers: ["Gestructureerd: je vergeet niets", "Kort en bondig: bespaart tijd", "Duidelijke vraag aan het eind: de ander weet wat je nodig hebt", "Universeel: werkt met alle disciplines", "Voorkomt miscommunicatie en aannames"] },
          { question: "Hoe ga je om met meningsverschillen in een multidisciplinair overleg?", expectedAnswers: ["Luister eerst naar alle perspectieven zonder te onderbreken", "Vraag door: 'Waarom vind je dat?'", "Weeg argumenten: wat is het beste voor de pati√´nt?", "Zoek naar compromissen of tussenoplossingen", "Bij blijvend verschil: leg voor aan pati√´nt of betrek leidinggevende", "Documenteer de verschillende standpunten en het besluit"] },
          { question: "Wanneer gebruik je SBAR en wanneer is een informeel gesprek voldoende?", expectedAnswers: ["SBAR bij: acute situaties, overdracht aan arts, telefonisch consult, escalatie", "Informeel bij: dagelijkse afstemming, bekende situaties, niet-urgent", "Bij twijfel: liever SBAR gebruiken dan te informeel communiceren"] }
        ],
        groupWork: {
          title: "Rollenspel: Multidisciplinair Overleg over ontslag Mw. De Boer",
          durationMinutes: 15,
          steps: [
            "Verdeel de rollen: verpleegkundige, arts, fysiotherapeut, mantelzorger (zoon). Lees je rolkaart.",
            "Verpleegkundige: Je kent mw. De Boer het beste. Open het MDO met een SBAR: Situatie (75jr, heupoperatie 5 dagen geleden), Background (woont alleen, was zelfstandig), Assessment (loopt nog instabiel, is gemotiveerd), Recommendation (wat vind jij verstandig?).",
            "Arts: Stel vragen over de medische situatie. Wanneer is het medisch verantwoord om naar huis te gaan?",
            "Fysiotherapeut: Geef advies over mobiliteit. Ze heeft nog oefeningen nodig. Kan dat thuis? Is thuiszorg nodig?",
            "Mantelzorger (zoon): Je maakt je zorgen. Je moeder wil graag naar huis, maar jij werkt fulltime. Wie vangt haar op?",
            "Voer het MDO uit (10 min). Kom tot een concreet plan met datum en afspraken.",
            "Leg de afspraken vast: Wie doet wat? Wanneer evalueren? Noteer in het zorgplan."
          ]
        }
      },
      // Detailed content for teacher handbook
      detailedContent: {
        SBAR: {
          S: {
            title: "Situation (Situatie)",
            explanation: "De S staat voor Situatie. Je vertelt WIE je bent en WAT er NU aan de hand is. Dit is de opening van je gesprek.",
            format: "Ik ben [naam], [functie] van [afdeling]. Ik bel over [pati√´nt naam], kamer [nummer]. Het probleem is [kort en concreet].",
            example: "Goedemiddag, ik ben Lisa, verpleegkundige van afdeling Interne. Ik bel over meneer Jansen, kamer 12. Hij is acuut benauwd geworden.",
            tips: ["Wees kort en concreet", "Noem direct de kern van het probleem", "Gebruik de naam en locatie van de pati√´nt"]
          },
          B: {
            title: "Background (Achtergrond)",
            explanation: "De B staat voor Background. Je geeft relevante voorgeschiedenis die de ander nodig heeft om de situatie te begrijpen.",
            format: "De pati√´nt is opgenomen vanwege [reden]. Relevante voorgeschiedenis: [ziekten, allergie√´n]. Huidige behandeling: [medicatie, interventies].",
            example: "Meneer Jansen is 3 dagen geleden opgenomen met een pneumonie. Hij heeft COPD en diabetes type 2. Hij krijgt antibiotica IV en prednison.",
            tips: ["Alleen relevante informatie", "Geen meningen in dit deel (dat komt bij A)", "Kort maar volledig"]
          },
          A: {
            title: "Assessment (Beoordeling)",
            explanation: "De A staat voor Assessment. Je geeft jouw professionele inschatting van de situatie. Dit is waar je laat zien dat je klinisch kunt redeneren.",
            format: "Ik heb het volgende vastgesteld: [observaties]. Vitale functies zijn: [waarden]. Ik denk dat er sprake is van [jouw analyse].",
            example: "Zijn saturatie is nu 88% zonder zuurstof, temperatuur 39.4, ademfrequentie 28/min. Hij gebruikt hulpademhalingsspieren. Ik vermoed dat zijn pneumonie verslechtert.",
            tips: ["Geef concrete meetwaarden", "Durf je mening te geven", "Het is ok√© om te zeggen 'ik vermoed' of 'ik maak me zorgen over'"]
          },
          R: {
            title: "Recommendation (Advies)",
            explanation: "De R staat voor Recommendation. Je vraagt concreet wat je nodig hebt. Dit is het belangrijkste deel - zonder duidelijke vraag weet de ander niet wat je verwacht.",
            format: "Ik vraag/stel voor om [concrete actie]. Kunt u [specifieke vraag]? Wanneer kan ik u verwachten?",
            example: "Ik heb hem alvast rechtop gezet en zuurstof 3 liter gegeven. Kunt u zo snel mogelijk komen kijken? Of wilt u dat ik alvast een thoraxfoto laat maken?",
            tips: ["Wees concreet: wat wil je dat de ander doet?", "Geef aan wat je al gedaan hebt", "Vraag om een tijdsindicatie"]
          }
        },
        completeExample: "Goedemiddag, met Lisa van Interne. [S] Ik bel over meneer Jansen, kamer 12. Hij is acuut benauwd geworden. [B] Hij ligt hier 3 dagen met een pneumonie, COPD-pati√´nt, krijgt antibiotica en prednison. [A] Zijn saturatie is gezakt naar 88%, temperatuur 39.4, hij ademt 28 keer per minuut. Ik vermoed verslechtering van de pneumonie. [R] Kunt u hem zo snel mogelijk komen beoordelen? Ik heb hem rechtop gezet en zuurstof gegeven."
      },
      recommendations: [
        { id: "mat-sbar-1", title: "SBAR-template overdracht (B1-K2-W2)", fileName: "B1-K2-W2-sbar-template.txt", contentType: "Template", score: 0.687, snippet: "SBAR-template met invulvelden: S ‚Äì Situatie: Ik ben..., ik bel over..., het probleem is... B ‚Äì Background: Opgenomen vanwege..., voorgeschiedenis..., huidige behandeling..." },
        { id: "mat-sbar-2", title: "Rollenspel MDO ontslag Mw. De Boer (B1-K2-W2)", fileName: "B1-K2-W2-rollenspel-mdo.txt", contentType: "Rollenspel", score: 0.623, snippet: "Casus: Mw. De Boer (75) na heupoperatie. Rollen: verpleegkundige (SBAR-overdracht), arts (medische beslissing), fysiotherapeut (mobiliteitsadvies), zoon (mantelzorgperspectief)..." }
      ],
      citations: [
        { source: "mes", course_id: "mes:kd2026-vig-vp", item_index: 8, similarity: 0.88, text: "De beginnend beroepsbeoefenaar werkt samen met andere zorgprofessionals. Communiceert effectief via gestructureerde overdracht (SBAR)..." },
        { source: "material", course_id: "material:b7697682", item_index: 0, similarity: 0.69, text: "SBAR-template: S ‚Äì Situatie: Ik ben [naam], [functie]. Ik bel over [pati√´nt]. Het probleem is [concreet]..." }
      ]
    };

    // Demo for reflectie query (B1-K3-W2) - NOW WITH FULL LESSON PLAN
    const demoReflectie = {
      lessonPlan: {
        kdAlignment: { code: "B1-K3-W2", title: "Evalueert de werkzaamheden en ontwikkelt zichzelf als professional" },
        quickStart: {
          oneLiner: "Studenten leren gestructureerd reflecteren op praktijksituaties met de STARR-methode en formuleren concrete verbeterpunten.",
          timeAllocation: { start: 10, kern: 30, afsluiting: 10 },
          keyConcepts: ["STARR-methode", "Feedback geven/ontvangen", "Leerdoelen", "Portfolio", "Professionele groei"]
        },
        teacherScript: [
          { time: "0-5 min", phase: "Start", action: "Activeer", content: "Vraag aan de klas: 'Denk aan een moment in de praktijk dat je trots was, of juist onzeker of een beetje schrok. Wat gebeurde er? Deel in 1 zin met je buurman.' Laat 2-3 studenten kort delen. Dit zijn perfecte situaties om op te reflecteren!" },
          { time: "5-10 min", phase: "Start", action: "Verbind", content: "Introduceer STARR: 'STARR is een reflectiemethode die je helpt om gestructureerd te leren van je ervaringen. Het verschil tussen 'iets meemaken' en 'ervan leren' zit in de reflectie. STARR staat voor: Situatie, Taak, Actie, Resultaat, Reflectie. De laatste R is het belangrijkst!' Link naar KD B1-K3-W2 en naar portfolio/stagegesprekken." },
          { time: "10-15 min", phase: "Kern", action: "Instructie S+T", content: "Leg de eerste twee letters uit met een voorbeeld:\n\nS = SITUATIE: 'Beschrijf de situatie objectief, alsof je een filmcamera bent. Alleen feiten, nog geen mening!' Hulpvragen: Waar speelde dit? Wie waren erbij? Wat was de aanleiding? Wanneer? Voorbeeldzin: 'Op dinsdag tijdens de avonddienst in het verpleeghuis kreeg mevrouw De Vries (82) plotseling pijn op de borst. Ik was als enige verpleegkundige aanwezig, samen met twee verzorgenden.'\n\nT = TAAK: 'Beschrijf wat jouw rol en verantwoordelijkheid was.' Hulpvragen: Wat werd van jou verwacht? Wat was jouw functie? Voorbeeldzin: 'Als dienstdoende verpleegkundige was ik verantwoordelijk voor de medische beoordeling en het nemen van beslissingen over vervolgacties.'" },
          { time: "15-22 min", phase: "Kern", action: "Instructie A+R1", content: "Leg de volgende twee letters uit:\n\nA = ACTIE: 'Beschrijf precies wat JIJ deed. Niet wat het team deed, maar jij!' Gebruik ik-taal, geen wij of men. Hulpvragen: Wat heb je gedaan? In welke volgorde? Welke keuzes maakte je? Voorbeeldzin: 'Ik ben direct naar mevrouw toegegaan en heb ABCDE toegepast. Ik heb haar vitale functies gemeten: bloeddruk 160/95, pols 110, saturatie 94%. Ik heb de huisarts gebeld via SBAR en nitroglycerine gegeven.'\n\nR = RESULTAAT: 'Beschrijf wat er gebeurde als gevolg van jouw acties.' Beschrijf ook onverwachte of negatieve resultaten! Voorbeeldzin: 'De huisarts kwam binnen 15 minuten en besloot mevrouw in te sturen. De ambulance was er na 20 minuten. Mevrouw was gerustgesteld door mijn uitleg. Achteraf bleek het een angina pectoris aanval.'" },
          { time: "22-28 min", phase: "Kern", action: "Instructie R2", content: "Leg de laatste en BELANGRIJKSTE letter uit:\n\nR = REFLECTIE: 'Dit is waar je echt leert! Wat heb je geleerd van deze ervaring?' Hulpvragen: Wat ging goed en waarom? Wat had ik anders kunnen doen? Wat heb ik geleerd? Wat neem ik mee naar een volgende keer? Welke theorie of richtlijn is van toepassing?\n\nKoppel aan theorie en competenties! Voorbeeldzin: 'Ik ben tevreden dat ik rustig bleef en systematisch werkte met ABCDE. Door SBAR te gebruiken kon ik duidelijk communiceren. Wat ik anders zou doen: het ECG-apparaat sneller pakken. Ik merk dat ik onder druk goed functioneer, maar wil nog oefenen met acute hartklachten herkennen. Dit sluit aan bij KD B1-K1-W5.'\n\nBelangrijk: de Reflectie is GEEN samenvatting! Het gaat om diepgang en zelfinzicht." },
          { time: "28-40 min", phase: "Kern", action: "Oefenen", content: "Studenten schrijven individueel een STARR-reflectie (12 min). Opdracht: 'Kies een situatie uit je stage of praktijkervaring. Gebruik het werkblad en schrijf voor elke letter minimaal 3 zinnen. Bij de Reflectie: koppel aan theorie of KD.' Loop rond, geef individuele tips. Veelgemaakte fouten: S en T door elkaar halen, A te kort, R is een samenvatting ipv reflectie." },
          { time: "40-45 min", phase: "Afsluiting", action: "Peer Feedback", content: "In duo's: wissel reflecties uit. Feedbackopdracht: 'Lees elkaars reflectie. Geef 1 compliment (wat is goed?) en 1 tip (wat kan beter?). Let vooral op de R: is er echt gereflecteerd of alleen beschreven?' Regels voor feedback: wees specifiek, beschrijf gedrag niet persoon, geef concrete suggesties." },
          { time: "45-50 min", phase: "Afsluiting", action: "Leerdoel formuleren", content: "Iedereen formuleert 1 concreet leerdoel voor de komende stageperiode op basis van hun reflectie. Format: 'Over [periode] wil ik [concreet gedrag] zodat [resultaat].' Voorbeeld: 'Over 4 weken wil ik bij elke acute situatie binnen 30 seconden het ECG-apparaat pakken, zodat ik sneller cardiale problemen kan uitsluiten.' Laat 2-3 studenten delen. Sluit af: 'Reflecteren is geen papiertje invullen - het is een vaardigheid die je moet oefenen!'" }
        ],
        discussionQuestions: [
          { question: "Wat is het verschil tussen beschrijven en reflecteren?", expectedAnswers: ["Beschrijven = WAT er gebeurde (feiten, gebeurtenissen)", "Reflecteren = WAT JE ERVAN LEERT (inzicht, betekenis)", "Bij beschrijven blijf je aan de oppervlakte, bij reflecteren ga je de diepte in", "Reflecteren verbindt de ervaring aan theorie, richtlijnen of competenties", "Beschrijven kan iedereen, reflecteren vraagt zelfinzicht en eerlijkheid"] },
          { question: "Hoe ontvang je feedback zonder defensief te worden?", expectedAnswers: ["Luister eerst helemaal uit zonder te onderbreken", "Vraag door: 'Kun je een voorbeeld geven?' of 'Wat bedoel je precies?'", "Bedank de ander voor de feedback (ook als je het er niet mee eens bent)", "Neem tijd om het te verwerken voordat je reageert", "Zie feedback als een cadeautje: iemand neemt de moeite om je te helpen verbeteren", "Je hoeft het niet meteen op te lossen - noteer het en denk er later over na"] },
          { question: "Welke rol speelt reflecteren in je professionele ontwikkeling?", expectedAnswers: ["Je leert van je ervaringen in plaats van ze alleen mee te maken", "Je wordt bewust bekwaam: je weet niet alleen WAT je doet, maar ook WAAROM", "Je bouwt je portfolio op met bewijzen van je competenties", "Je bereidt je voor op stagegesprekken en voortgangsgesprekken", "Je ontwikkelt zelfinzicht: waar ben je goed in, waar moet je aan werken?", "Het is de basis van leven lang leren in de zorg"] }
        ],
        groupWork: {
          title: "Peer Feedback Oefening op STARR-reflecties",
          durationMinutes: 15,
          steps: [
            "Wissel je STARR-reflectie met een klasgenoot. Lees elkaars reflectie aandachtig door (2 min per reflectie).",
            "Check per onderdeel: S - Is de situatie objectief beschreven? Alleen feiten? T - Is duidelijk wat de rol/verantwoordelijkheid was?",
            "Check: A - Is beschreven wat de persoon ZELF deed? Staat er 'ik' en niet 'wij'? R - Is het resultaat beschreven, inclusief onverwachte uitkomsten?",
            "Check de Reflectie (belangrijkst!): Is er ECHT gereflecteerd of alleen samengevat? Is er een koppeling met theorie/KD? Zijn er concrete verbeterpunten?",
            "Geef feedback: 1 concreet compliment + 1 concrete tip. Wees specifiek! Niet: 'goed geschreven' maar: 'je hebt goed uitgelegd wat je voelde bij de A'",
            "Bespreek samen: wat kunnen jullie van elkaar leren? Welke tips neem je mee?",
            "Pas je eigen reflectie aan op basis van de feedback die je kreeg."
          ]
        }
      },
      // Detailed content for teacher handbook
      detailedContent: {
        STARR: {
          S: {
            title: "Situatie",
            explanation: "Beschrijf de situatie objectief, alsof je een filmcamera bent. Alleen feiten, nog geen mening of gevoel!",
            helpQuestions: ["Waar speelde dit zich af?", "Wie waren erbij betrokken?", "Wat was de aanleiding?", "Wanneer gebeurde dit?"],
            example: "Op dinsdag tijdens de avonddienst in het verpleeghuis kreeg mevrouw De Vries (82) plotseling pijn op de borst. Ik was als enige verpleegkundige aanwezig, samen met twee verzorgenden.",
            commonMistakes: ["Te veel details die niet relevant zijn", "Al meningen of gevoelens toevoegen", "De situatie en taak door elkaar halen"]
          },
          T: {
            title: "Taak",
            explanation: "Beschrijf wat jouw rol en verantwoordelijkheid was in deze situatie.",
            helpQuestions: ["Wat werd er van jou verwacht?", "Wat was jouw functie op dat moment?", "Wie had de leiding?", "Welke verantwoordelijkheden had jij?"],
            example: "Als dienstdoende verpleegkundige was ik verantwoordelijk voor de medische beoordeling en het nemen van beslissingen over vervolgacties.",
            commonMistakes: ["Verwarren met de situatie", "Te algemeen blijven", "Verantwoordelijkheden onderschatten of overschatten"]
          },
          A: {
            title: "Actie",
            explanation: "Beschrijf precies wat JIJ deed (niet wat het team deed). Gebruik ik-taal, geen wij of men.",
            helpQuestions: ["Wat heb je gedaan?", "In welke volgorde?", "Welke keuzes maakte je?", "Wat zei je?"],
            example: "Ik ben direct naar mevrouw toegegaan en heb ABCDE toegepast. Ik heb haar vitale functies gemeten: bloeddruk 160/95, pols 110, saturatie 94%. Ik heb de huisarts gebeld via SBAR en nitroglycerine sublinguaal gegeven.",
            commonMistakes: ["'Wij' gebruiken in plaats van 'ik'", "Te kort en vaag blijven", "Alleen het resultaat beschrijven, niet de stappen"]
          },
          R1: {
            title: "Resultaat",
            explanation: "Beschrijf het resultaat: wat gebeurde er als gevolg van jouw acties? Beschrijf ook onverwachte of negatieve resultaten.",
            helpQuestions: ["Wat was de uitkomst?", "Hoe reageerden anderen?", "Werd het doel bereikt?", "Wat was het effect?"],
            example: "De huisarts kwam binnen 15 minuten en besloot mevrouw te laten insturen naar het ziekenhuis. De ambulance was er na 20 minuten. Mevrouw was gerustgesteld door mijn uitleg. Achteraf bleek het een angina pectoris aanval te zijn.",
            commonMistakes: ["Alleen positieve resultaten noemen", "Het resultaat verzinnen of aanpassen", "Te kort zijn over het effect op anderen"]
          },
          R2: {
            title: "Reflectie",
            explanation: "Dit is het belangrijkste deel! Wat heb je geleerd? Koppel aan theorie en competenties. Dit is GEEN samenvatting!",
            helpQuestions: ["Wat ging goed en waarom?", "Wat had ik anders kunnen doen?", "Wat heb ik geleerd?", "Wat neem ik mee naar een volgende keer?", "Welke theorie/richtlijn is van toepassing?"],
            example: "Ik ben tevreden dat ik rustig bleef en systematisch werkte met ABCDE. Door de SBAR te gebruiken kon ik duidelijk communiceren. Wat ik anders zou doen: ik had het ECG-apparaat sneller kunnen pakken. Ik merk dat ik onder druk goed functioneer, maar wil nog oefenen met acute hartklachten herkennen. Dit sluit aan bij KD B1-K1-W5: handelen in acute situaties.",
            commonMistakes: ["Alleen samenvatten wat er gebeurde", "Geen koppeling met theorie of KD", "Geen concrete verbeterpunten formuleren", "Te oppervlakkig blijven: 'het ging goed'"]
          }
        },
        feedbackRegels: {
          geven: ["Wees specifiek: niet 'goed gedaan' maar 'je hebt duidelijk beschreven wat je voelde'", "Beschrijf gedrag, niet de persoon", "Geef concrete suggesties voor verbetering", "Balanceer positief en constructief"],
          ontvangen: ["Luister uit zonder te onderbreken", "Vraag door als iets onduidelijk is", "Bedank voor de feedback", "Neem tijd om te verwerken", "Je hoeft het niet meteen op te lossen"]
        }
      },
      recommendations: [
        { id: "mat-refl-1", title: "STARR-reflectie werkblad (B1-K3-W2)", fileName: "B1-K3-W2-starr-werkblad.txt", contentType: "Werkblad", score: 0.665, snippet: "STARR-werkblad met invulvelden en hulpvragen. S: Waar, wie, wat, wanneer? T: Jouw rol en verantwoordelijkheid. A: Wat deed JIJ precies (ik-taal)? R: Wat was het resultaat? R: Wat leer je hiervan?" },
        { id: "mat-refl-2", title: "Reflectievragen voor stagegesprek (B1-K3-W2)", fileName: "B1-K3-W2-reflectievragen.txt", contentType: "Reflectie", score: 0.605, snippet: "Reflectievragen: 1) Welke situatie vond je lastig en waarom? 2) Wat deed je goed? 3) Wat zou je anders doen? 4) Welke competentie heb je ontwikkeld? 5) Wat is je leerdoel?" },
        { id: "mat-refl-3", title: "Gids: Feedback geven en ontvangen (B1-K3-W2)", fileName: "B1-K3-W2-feedback-gids.txt", contentType: "Gids", score: 0.578, snippet: "Feedback geven: wees specifiek, beschrijf gedrag (niet persoon), geef concrete suggesties. Feedback ontvangen: luister uit, vraag door, bedank, verwerk later." }
      ],
      citations: [
        { source: "mes", course_id: "mes:kd2026-vig-vp", item_index: 12, similarity: 0.85, text: "De beginnend beroepsbeoefenaar evalueert de werkzaamheden en ontwikkelt zichzelf als professional. Reflecteert op het eigen handelen en formuleert verbeterpunten..." },
        { source: "material", course_id: "material:refl-starr-01", item_index: 0, similarity: 0.66, text: "STARR-reflectie werkblad: S ‚Äì Situatie: beschrijf objectief. T ‚Äì Taak: jouw rol. A ‚Äì Actie: wat deed JIJ. R ‚Äì Resultaat: uitkomst. R ‚Äì Reflectie: wat leer je, koppel aan theorie..." }
      ]
    };

    // Demo for zorginterventies (B1-K1-W3) - COMPLETES THE 5 WORKSHOP KD CODES
    const demoZorginterventies = {
      lessonPlan: {
        kdAlignment: { code: "B1-K1-W3", title: "Voert zorginterventies en/of begeleidingsactiviteiten uit" },
        quickStart: {
          oneLiner: "Studenten leren zorginterventies veilig uit te voeren met aandacht voor eigen regie van de zorgvrager.",
          timeAllocation: { start: 10, kern: 35, afsluiting: 5 },
          keyConcepts: ["Veilige zorg", "Eigen regie", "Zorgplan", "Hygi√´ne", "Rapportage"]
        },
        teacherScript: [
          { time: "0-5 min", phase: "Start", action: "Activeer", content: "Vraag aan de klas: 'Welke zorghandeling vind je lastig om uit te voeren? En wat kan er misgaan als je niet oplet?' Verzamel antwoorden: bloeddruk meten, injecties geven, wondverzorging, katheterisatie, etc. Bespreek kort: elke handeling vraagt voorbereiding, uitleg en zorgvuldigheid." },
          { time: "5-10 min", phase: "Start", action: "Verbind", content: "Link naar het zorgplan: 'In het zorgplan staat WELKE interventies nodig zijn. Maar hoe je ze uitvoert, dat is jullie vakmanschap.' Leg uit: 'Elke interventie heeft 4 fasen: Voorbereiding, Uitleg aan zorgvrager (eigen regie!), Uitvoering, Rapportage. Vergeet er geen!' Link naar KD B1-K1-W3." },
          { time: "10-20 min", phase: "Kern", action: "Protocol bloeddruk", content: "Demonstreer bloeddruk meten met uitgebreid protocol:\n\nVOORBEREIDING:\n1. Was je handen volgens de 6-stappen methode (30 seconden met zeep, goed afspoelen, droogdeppen)\n2. Verzamel materiaal: bloeddrukmeter, juiste manchetmaat\n3. Controleer of apparatuur werkt (batterijen, slangetje)\n4. Kijk in zorgplan: zijn er bijzonderheden? (bijv. niet aan rechterarm door shunt)\n\nUITLEG AAN ZORGVRAGER (eigen regie!):\n5. Stel jezelf voor als dat nog niet is gebeurd\n6. Leg uit: 'Ik ga uw bloeddruk meten om te kijken hoe uw hart en bloedvaten werken'\n7. Vraag: 'Is dat goed?' (toestemming = informed consent)\n8. Vraag: 'Heeft u vragen of bijzonderheden?'" },
          { time: "20-28 min", phase: "Kern", action: "Protocol vervolg", content: "UITVOERING:\n9. Laat zorgvrager minimaal 5 minuten rustig zitten\n10. Ondersteun de arm op harthoogte (tafel of kussen)\n11. Leg manchet 2-3 cm boven elleboogplooi\n12. Manchet niet te strak: 1-2 vingers eronder\n13. Start meting, vraag zorgvrager stil te zijn\n14. Wacht op resultaat\n\nNAZORG:\n15. Verwijder manchet voorzichtig\n16. Vertel het resultaat aan zorgvrager: 'Uw bloeddruk is 135/85'\n17. Leg uit wat normaal is: 'Normaal is rond de 120/80'\n18. Vraag: 'Heeft u nog vragen?'\n\nRAPPORTAGE:\n19. Noteer in dossier: datum, tijd, waarde, welke arm (L/R), houding (zittend/liggend), bijzonderheden\n20. Vergelijk met vorige metingen: trend?\n21. Bij afwijkende waarden: meld direct aan collega/arts" },
          { time: "28-45 min", phase: "Kern", action: "Oefenen in tweetallen", content: "Studenten oefenen in tweetallen (wisselend na 8 min). Rollen: (1) Verzorgende: voert handeling uit volgens protocol, (2) Zorgvrager: speelt realistische reacties ('Niet aan die arm!', 'Wat gaat u doen?'), (3) Observator: checkt protocol met checklist. Geef de checklist uit met alle stappen. Observator let op: handhygi√´ne, uitleg vooraf, toestemming vragen, juiste techniek, nazorg, rapportage. Loop rond en geef feedback." },
          { time: "45-50 min", phase: "Afsluiting", action: "Nabespreking", content: "Klassikale nabespreking. Vraag: 'Wat ging goed? Wat was lastig?' Bespreek veelgemaakte fouten: handhygi√´ne vergeten, geen toestemming gevraagd, manchet verkeerd geplaatst, resultaat niet uitgelegd aan zorgvrager. Benadruk: 'Eigen regie betekent dat je ALTIJD uitlegt en vraagt. Ook bij routinehandelingen!' Vraag: 'Hoe rapporteer je een afwijkende waarde?' Sluit af: 'Vakmanschap zit in de details - elke stap telt.'" }
        ],
        discussionQuestions: [
          { question: "Hoe vraag je toestemming aan de zorgvrager (informed consent)?", expectedAnswers: ["Leg eerst uit WAT je gaat doen en WAAROM: 'Ik ga uw bloeddruk meten om te controleren hoe uw hart werkt'", "Gebruik begrijpelijke taal, geen vaktermen", "Vraag expliciet: 'Is dat goed?' of 'Mag ik beginnen?'", "Bied alternatieven als die er zijn: 'Wilt u liever zitten of liggen?'", "Geef tijd om na te denken en vragen te stellen", "Bij twijfel over wilsbekwaamheid: schakel collega of contactpersoon in"] },
          { question: "Wat doe je als de zorgvrager weigert?", expectedAnswers: ["Respecteer de weigering - de zorgvrager heeft het recht om nee te zeggen", "Vraag door naar de reden: 'Mag ik vragen waarom u dit niet wilt?'", "Soms is er angst, pijn of een misverstand dat je kunt wegnemen", "Leg de consequenties uit zonder te dreigen: 'Als we uw bloeddruk niet meten, kan ik niet inschatten of...'", "Bied een alternatief moment aan: 'Zullen we het over een uurtje opnieuw proberen?'", "Documenteer de weigering en de reden in het dossier", "Overleg met collega of arts als de interventie medisch noodzakelijk is"] },
          { question: "Waarom is handhygi√´ne zo belangrijk bij zorghandelingen?", expectedAnswers: ["Voorkomt overdracht van ziektekiemen tussen zorgvragers", "Beschermt de zorgvrager tegen infecties (vooral kwetsbare ouderen)", "Beschermt jezelf als zorgverlener", "Is de belangrijkste maatregel tegen zorginfecties", "6-stappen methode: palm, rug, tussen vingers, knokkels, duimen, nagels", "30 seconden met zeep OF handalcohol als handen niet zichtbaar vuil zijn", "VOOR en NA elk cli√´ntcontact, na handschoenen uit, voor schone handelingen"] }
        ],
        groupWork: {
          title: "Praktijkoefening: Bloeddruk meten volgens protocol",
          durationMinutes: 20,
          steps: [
            "Verdeel rollen: verzorgende (voert uit), zorgvrager (speelt cli√´nt), observator (checkt met lijst). Na 8 minuten wisselen.",
            "Verzorgende: Begin met handhygi√´ne (6 stappen, 30 sec). Verzamel materiaal, check apparatuur.",
            "Verzorgende: Stel jezelf voor, leg uit wat je gaat doen: 'Ik ga uw bloeddruk meten om te kijken hoe uw hart werkt. Is dat goed?'",
            "Zorgvrager: Reageer realistisch. Stel vragen ('Doet dat pijn?'), geef weerstand ('Liever niet aan die arm'), wees wat onrustig.",
            "Verzorgende: Voer de meting uit volgens protocol. Vertel het resultaat. Vraag of er vragen zijn.",
            "Verzorgende: Rapporteer hardop wat je zou noteren: datum, tijd, waarde, arm, houding, bijzonderheden.",
            "Observator: Check met de checklist. Geef na afloop feedback: 1 compliment + 1 verbeterpunt."
          ]
        }
      },
      // Detailed content for teacher handbook
      detailedContent: {
        handhygiene: {
          stappen: [
            "Maak handen nat onder stromend water",
            "Neem zeep en verdeel over handen",
            "Stap 1: Wrijf palm tegen palm",
            "Stap 2: Wrijf rechterpalm over linkerhandrug en vice versa",
            "Stap 3: Wrijf palm tegen palm met vingers in elkaar",
            "Stap 4: Wrijf rugkant vingers tegen palm andere hand",
            "Stap 5: Wrijf duim in gesloten palm en vice versa",
            "Stap 6: Draai vingertoppen in palm (nagels) en vice versa",
            "Spoel af onder stromend water",
            "Dep droog met papieren handdoek"
          ],
          wanneer: ["VOOR direct cli√´ntcontact", "VOOR schone/aseptische handelingen", "NA blootstelling aan lichaamsvloeistoffen", "NA cli√´ntcontact", "NA contact met cli√´ntomgeving"]
        },
        protocolBloeddruk: {
          voorbereiding: ["Was handen (6-stappen methode)", "Verzamel materiaal: bloeddrukmeter, juiste manchetmaat", "Controleer apparatuur", "Check zorgplan voor bijzonderheden"],
          uitleg: ["Stel jezelf voor", "Leg uit wat je gaat doen en waarom", "Vraag toestemming (informed consent)", "Vraag of er vragen zijn"],
          uitvoering: ["Laat zorgvrager 5 min rustig zitten", "Ondersteun arm op harthoogte", "Leg manchet 2-3 cm boven elleboogplooi", "Manchet niet te strak (1-2 vingers)", "Start meting, vraag om stilte"],
          nazorg: ["Verwijder manchet voorzichtig", "Vertel resultaat", "Leg uit wat normaal is", "Vraag of er vragen zijn"],
          rapportage: ["Noteer: datum, tijd, waarde, arm, houding", "Vergelijk met vorige metingen", "Meld afwijkingen aan collega/arts"]
        },
        ADLcategorie√´n: {
          wassen: "Hulp bij persoonlijke hygi√´ne: wassen gezicht, bovenlichaam, onderlichaam, haren wassen",
          aankleden: "Hulp bij kleding: bovenkeding, onderkeding, schoeisel, hulpmiddelen",
          eten: "Hulp bij voeding: maaltijdbereiding, eten aanreiken, voeden, drinken",
          mobiliteit: "Hulp bij bewegen: transfers (bed-stoel), lopen, traplopen, rolstoel",
          toiletgang: "Hulp bij toiletbezoek: naar toilet brengen, continentiezorg, katheter, stoma",
          communicatie: "Ondersteuning bij communicatie: gehoor, zicht, spraak, hulpmiddelen"
        },
        eigenRegie: {
          definitie: "Eigen regie betekent dat de zorgvrager zelf de regie houdt over zijn/haar leven en zorg, ook als er hulp nodig is.",
          inPraktijk: [
            "ALTIJD uitleggen wat je gaat doen voordat je begint",
            "ALTIJD toestemming vragen (ook bij routinehandelingen)",
            "Keuzes aanbieden waar mogelijk: 'Wilt u eerst uw gezicht of uw armen wassen?'",
            "Respecteer tempo van de zorgvrager",
            "Stimuleer zelfstandigheid: doe niet VOOR wat iemand ZELF kan",
            "Accepteer weigering - de zorgvrager beslist"
          ]
        }
      },
      recommendations: [
        { id: "mat-zorg-1", title: "Checklist zorginterventies veilig uitvoeren (B1-K1-W3)", fileName: "B1-K1-W3-checklist-zorginterventies.txt", contentType: "Checklist", score: 0.712, snippet: "Checklist: 1) Handhygi√´ne uitgevoerd 2) Zorgplan geraadpleegd 3) Uitleg gegeven aan zorgvrager 4) Toestemming gevraagd 5) Correct uitgevoerd 6) Resultaat gecommuniceerd 7) Gerapporteerd" },
        { id: "mat-zorg-2", title: "Protocol ADL-ondersteuning (B1-K1-W3)", fileName: "B1-K1-W3-protocol-adl.txt", contentType: "Protocol", score: 0.645, snippet: "ADL-protocol: Voorbereiding (materiaal, privacy), Uitleg (wat, waarom, toestemming), Uitvoering (veilig, eigen regie), Nazorg (comfort, observaties), Rapportage (dossier, bijzonderheden)" }
      ],
      citations: [
        { source: "mes", course_id: "mes:kd2026-vig-vp", item_index: 3, similarity: 0.91, text: "De beginnend beroepsbeoefenaar voert de interventies uit zoals beschreven in het zorgplan, stimuleert de eigen regie van de zorgvrager, hanteert hygi√´nerichtlijnen..." },
        { source: "material", course_id: "material:f3a92178", item_index: 0, similarity: 0.71, text: "Checklist zorginterventies: 1) Handhygi√´ne (6 stappen) 2) Check zorgplan 3) Uitleg vooraf 4) Vraag toestemming 5) Voer uit volgens protocol 6) Communiceer resultaat 7) Rapporteer..." }
      ]
    };

    // ========================================
    // TOAST NOTIFICATIONS
    // ========================================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast--${type}`;
      
      const icons = {
        success: '‚úì',
        info: '‚Ñπ',
        warning: '‚ö†'
      };
      
      toast.innerHTML = `<span>${icons[type] || '‚Ñπ'}</span> ${message}`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // ========================================
    // MODAL
    // ========================================
    function showModal(title, text, confirmText, callback) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modalConfirm').textContent = confirmText;
      state.modalCallback = callback;
      document.getElementById('modalOverlay').classList.add('active');
    }

    function closeModal(event) {
      // If event is provided, only close if clicking the overlay itself (not child elements)
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('modalOverlay').classList.remove('active');
      state.modalCallback = null;
    }

    function confirmModal() {
      if (state.modalCallback) {
        state.modalCallback();
      }
      closeModal();
    }

    // ========================================
    // SETTINGS PANEL
    // ========================================
    function toggleSettings() {
      state.settingsOpen = !state.settingsOpen;
      document.getElementById('settingsPanel').classList.toggle('open', state.settingsOpen);
      document.getElementById('settingsBtn').classList.toggle('active', state.settingsOpen);
    }

    function handleScopeChange(scope) {
      state.currentScope = scope;
      
      // Sync with header toggle buttons
      document.querySelectorAll('.scope-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.scope === scope);
      });
      
      // Update dropdown
      document.getElementById('scopeSelect').value = scope;
      
      const scopeNames = {
        'all': 'Alles (Materialen + MES)',
        'materials': 'Alleen Materialen',
        'mes': 'Alleen MES'
      };
      showToast(`Scope: ${scopeNames[scope]}`, 'info');
      
      // Re-filter existing citations if a lesson plan is displayed
      if (state.currentPlan && state.currentCitations) {
        let filteredCitations = state.currentCitations;
        if (scope === 'materials') {
          filteredCitations = state.currentCitations.filter(c => c.source === 'material');
        } else if (scope === 'mes') {
          filteredCitations = state.currentCitations.filter(c => c.source === 'mes');
        }
        
        if (filteredCitations && filteredCitations.length > 0) {
          renderCitations(filteredCitations);
        } else {
          document.getElementById('sourcesEmpty').classList.remove('hidden');
          document.getElementById('sourcesContent').classList.add('hidden');
        }
      }
    }

    function handleMaterialChange(materialId) {
      state.selectedMaterialId = materialId;
      
      const infoEl = document.getElementById('selectedMaterialInfo');
      if (materialId) {
        const material = mockMaterials.find(m => m.id === materialId);
        if (material) {
          infoEl.innerHTML = `Geselecteerd: <strong>${material.title}</strong>`;
          showToast('Materiaal geselecteerd voor gerichte zoekactie', 'success');
        }
      } else {
        infoEl.textContent = '';
      }
    }

    function refreshMaterials() {
      const btn = document.getElementById('refreshMaterialsBtn');
      btn.classList.add('loading');
      btn.disabled = true;
      
      setTimeout(() => {
        btn.classList.remove('loading');
        btn.disabled = false;
        showToast('Materialen bijgewerkt', 'success');
      }, 1000);
    }

    // ========================================
    // ERROR HANDLING
    // ========================================
    function showError(message) {
      state.error = message;
      const alertEl = document.getElementById('errorAlert');
      document.getElementById('errorAlertText').textContent = message;
      alertEl.classList.remove('hidden');
    }

    function hideError() {
      state.error = null;
      document.getElementById('errorAlert').classList.add('hidden');
    }

    // ========================================
    // UI FUNCTIONS
    // ========================================
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.side-panel-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });
    }

    function clearChat() {
      state.messages = [];
      state.currentPlan = null;
      state.currentCitations = null;
      document.getElementById('chatMessages').innerHTML = `
        <div class="empty-state" id="emptyState">
          <div class="empty-state-icon">üí°</div>
          <h2>Welkom bij e-Xpert SAM</h2>
          <p>
            Vertel wat je wilt bereiken met je les, en ik maak een compleet lesplan voor je.
            De KD-aansluiting regel ik automatisch. Kies een onderwerp hieronder of typ je eigen vraag.
          </p>
        </div>
      `;
      document.getElementById('suggestionChips').classList.remove('hidden');
      
      // Reset panels
      document.getElementById('lesplanEmpty').classList.remove('hidden');
      document.getElementById('lesplanContent').classList.add('hidden');
      document.getElementById('materialsEmpty').classList.remove('hidden');
      document.getElementById('materialsContent').classList.add('hidden');
      document.getElementById('sourcesEmpty').classList.remove('hidden');
      document.getElementById('sourcesContent').classList.add('hidden');
      
      showToast('Gesprek gewist', 'info');
    }

    function useSuggestion(text) {
      document.getElementById('chatInput').value = text;
      // Auto-send for smooth demo experience
      sendMessage();
    }

    function handleInputKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function detectQueryType(text) {
      const lowerText = text.toLowerCase().trim();
      
      // Greetings and chitchat - detect FIRST before topic-specific queries
      const greetings = ['hallo', 'hello', 'hi', 'hoi', 'hey', 'goedemorgen', 'goedemiddag', 'goedenavond', 
                         'dag', 'hee', 'yo', 'welkom', 'bedankt', 'dank je', 'thanks', 'dankjewel',
                         'wie ben jij', 'wat kun je', 'wat kan je', 'help', 'wat doe je', 'wie ben je',
                         'wat is dit', 'hoe werkt dit', 'hoe werkt het', 'uitleg', 'introductie'];
      if (greetings.some(g => lowerText === g || lowerText.startsWith(g + ' ') || lowerText.endsWith(' ' + g))) {
        return 'greeting';
      }
      
      // Short casual messages (under 15 chars without specific keywords)
      if (lowerText.length < 15 && !lowerText.includes('les') && !lowerText.includes('plan') && 
          !lowerText.includes('zorg') && !lowerText.includes('kd') && !lowerText.includes('b1-')) {
        return 'greeting';
      }
      
      // KD informational questions - "wat is het kd", "wat is kd", "leg uit kd", etc.
      if ((lowerText.includes('wat is') && lowerText.includes('kd')) ||
          (lowerText.includes('wat zijn') && lowerText.includes('kd')) ||
          (lowerText.includes('leg uit') && lowerText.includes('kd')) ||
          (lowerText.includes('uitleg') && lowerText.includes('kd')) ||
          lowerText.includes('kwalificatiedossier') ||
          (lowerText.includes('wat betekent') && (lowerText.includes('kd') || lowerText.includes('b1-'))) ||
          (lowerText.includes('werkproces') && !lowerText.includes('lesplan') && !lowerText.includes('maak'))) {
        return 'kd_info';
      }
      
      // B1-K1-W5: Emergency/ABCDE - expanded with natural language keywords
      if (lowerText.includes('abcde') || lowerText.includes('acute') || lowerText.includes('nood') || 
          lowerText.includes('spoed') || lowerText.includes('alarm') || lowerText.includes('noodsituatie') ||
          lowerText.includes('levensbedreigende') || lowerText.includes('reanimatie') || lowerText.includes('b1-k1-w5')) {
        return 'abcde';
      }
      // B1-K2-W2: Collaboration/SBAR - expanded with natural language keywords
      if (lowerText.includes('samenwerk') || lowerText.includes('team') || lowerText.includes('sbar') || 
          lowerText.includes('mdo') || lowerText.includes('overdracht') || lowerText.includes('communicat') ||
          lowerText.includes('collega') || lowerText.includes('multidisciplin') || lowerText.includes('b1-k2-w2')) {
        return 'samenwerking';
      }
      // B1-K3-W2: Reflection - expanded with natural language keywords
      if (lowerText.includes('reflect') || lowerText.includes('starr') || lowerText.includes('stage') || 
          lowerText.includes('feedback') || lowerText.includes('leren van') || lowerText.includes('evalueren') ||
          lowerText.includes('verbeterpunt') || lowerText.includes('ontwikkel') || lowerText.includes('portfolio') ||
          lowerText.includes('b1-k3-w2')) {
        return 'reflectie';
      }
      // B1-K1-W3: Care interventions - expanded with natural language keywords
      if (lowerText.includes('interventie') || lowerText.includes('adl') || lowerText.includes('verpleegtechnisch') || 
          lowerText.includes('handeling') || lowerText.includes('bloeddruk') || lowerText.includes('wond') ||
          lowerText.includes('medicijn') || lowerText.includes('verzorging') || lowerText.includes('uitvoeren') ||
          lowerText.includes('veilig') || lowerText.includes('b1-k1-w3')) {
        return 'zorginterventies';
      }
      // B1-K1-W2: Care plan - expanded with natural language keywords
      if (lowerText.includes('zorgplan') || lowerText.includes('bijstellen') || lowerText.includes('doel') || 
          lowerText.includes('signaler') || lowerText.includes('verandert') || lowerText.includes('aanpassen') ||
          lowerText.includes('situatie verandert') || lowerText.includes('b1-k1-w2')) {
        return 'zorgplan';
      }
      // Default to zorgplan for demo
      return 'zorgplan';
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || state.isLoading) return;

      // Hide empty state and suggestions
      const emptyState = document.getElementById('emptyState');
      if (emptyState) emptyState.remove();
      document.getElementById('suggestionChips').classList.add('hidden');

      // Add user message
      addMessage('user', text);
      input.value = '';

      // Show loading
      state.isLoading = true;
      document.getElementById('sendBtn').classList.add('loading');
      document.getElementById('sendBtn').disabled = true;
      addTypingIndicator();

      // Detect query type
      const queryType = detectQueryType(text);

      // Simulate API response
      setTimeout(() => {
        removeTypingIndicator();
        
        let responseText, plan, recommendations, citations;

        switch (queryType) {
          case 'greeting':
            plan = null;
            recommendations = null;
            citations = null;
            const greetingResponses = [
              `Hallo! Ik ben **e-Xpert SAM**, je persoonlijke lesplan-assistent.

Ik help je met het maken van lesplannen die aansluiten bij het **KD 2026**. Vertel me wat je je studenten wilt leren, en ik maak een compleet lesplan met:
‚Ä¢ Quick Start voor snelle voorbereiding
‚Ä¢ Docentenscript met tijdsindeling
‚Ä¢ Discussievragen en groepsopdrachten
‚Ä¢ Relevante materialen uit jullie database

Kies een onderwerp uit de suggesties, of stel je eigen vraag!`,
              `Hoi! Leuk dat je er bent. Ik ben **e-Xpert SAM**.

Ik kan je helpen met lesplannen voor de Verpleegkundige opleiding. Vertel me welk onderwerp je wilt behandelen - bijvoorbeeld zorgplannen bijstellen, ABCDE-methodiek, of reflecteren - en ik maak een kant-en-klaar lesplan.

Waar wil je een les over maken?`,
              `Welkom bij **e-Xpert SAM**! 

Ik ben hier om je te helpen met lesvoorbereiding. Geef me een onderwerp of vraag, en ik genereer een lesplan dat aansluit bij het kwalificatiedossier.

Tip: klik op een van de suggesties hieronder om direct te starten!`
            ];
            responseText = greetingResponses[Math.floor(Math.random() * greetingResponses.length)];
            // Show suggestion chips again for greetings
            document.getElementById('suggestionChips').classList.remove('hidden');
            break;

          case 'kd_info':
            plan = null;
            recommendations = null;
            citations = null;
            responseText = `Het **KD** staat voor **Kwalificatiedossier** - dit is het landelijke document dat beschrijft wat een student moet kennen en kunnen om het diploma te behalen.

**Voor VIG/VP (Verpleegkundige niveau 4) bevat het KD 2026:**

‚Ä¢ **Kerntaken** (K) - de hoofdtaken van het beroep
‚Ä¢ **Werkprocessen** (W) - de concrete activiteiten binnen elke kerntaak
‚Ä¢ **Beroepsspecifieke eisen** - vakkennis en vaardigheden

**Voorbeelden van werkprocessen:**
‚Ä¢ **B1-K1-W2** - Zorgplan opstellen en bijstellen
‚Ä¢ **B1-K1-W3** - Zorginterventies uitvoeren
‚Ä¢ **B1-K1-W5** - Handelen in acute situaties (ABCDE)
‚Ä¢ **B1-K2-W2** - Samenwerken met zorgprofessionals
‚Ä¢ **B1-K3-W2** - Reflecteren en professioneel ontwikkelen

Ik kan lesplannen maken die aansluiten bij elk werkproces. Kies een onderwerp hieronder of vraag om een specifiek KD-onderdeel!`;
            document.getElementById('suggestionChips').classList.remove('hidden');
            break;

          case 'abcde':
            plan = demoABCDE.lessonPlan;
            recommendations = demoABCDE.recommendations;
            citations = demoABCDE.citations;
            responseText = `Ik heb een lesplan gemaakt voor **${plan.kdAlignment.code}** (${plan.kdAlignment.title}).

Dit lesplan focust op de ABCDE-methodiek voor acute situaties. Inclusief een simulatieoefening met allergische reactie.

Bekijk het volledige lesplan rechts. Ik heb ook relevante checklists en simulatiescenario's gevonden.`;
            break;

          case 'samenwerking':
            plan = demoSamenwerking.lessonPlan;
            recommendations = demoSamenwerking.recommendations;
            citations = demoSamenwerking.citations;
            responseText = `Ik heb een lesplan gemaakt voor **${plan.kdAlignment.code}** (${plan.kdAlignment.title}).

Dit lesplan draait om effectieve communicatie met SBAR en samenwerking in een MDO-rollenspel.

Bekijk het volledige lesplan rechts. Ik heb ook een SBAR-template en rollenspel-materiaal gevonden.`;
            break;

          case 'reflectie':
            plan = demoReflectie.lessonPlan;
            recommendations = demoReflectie.recommendations;
            citations = demoReflectie.citations;
            responseText = `Ik heb een lesplan gemaakt voor **${plan.kdAlignment.code}** (${plan.kdAlignment.title}).

Dit lesplan focust op gestructureerd reflecteren met de STARR-methode. Inclusief een peer feedback oefening waarin studenten elkaars reflecties bespreken.

Bekijk het volledige lesplan rechts. Ik heb ook werkbladen en reflectievragen gevonden.`;
            break;

          case 'zorginterventies':
            plan = demoZorginterventies.lessonPlan;
            recommendations = demoZorginterventies.recommendations;
            citations = demoZorginterventies.citations;
            responseText = `Ik heb een lesplan gemaakt voor **${plan.kdAlignment.code}** (${plan.kdAlignment.title}).

Dit lesplan focust op het veilig uitvoeren van zorginterventies met aandacht voor de eigen regie van de zorgvrager. Inclusief een praktijkoefening ADL-ondersteuning.

Bekijk het volledige lesplan rechts. Ik heb ook een checklist en protocol gevonden die je direct kunt gebruiken.`;
            break;

          default: // zorgplan
            plan = demoLessonPlan;
            recommendations = demoRecommendations;
            citations = demoCitations;
            responseText = `Ik heb een compleet lesplan gemaakt voor **${plan.kdAlignment.code}** (${plan.kdAlignment.title}). 

Het lesplan bevat een Quick Start voor snelle voorbereiding, een uitgewerkt docentenscript met tijdsindeling, discussievragen en een groepsopdracht.

Bekijk het volledige lesplan in het paneel rechts. Ik heb ook relevante materialen gevonden die je direct kunt gebruiken.`;
        }

        addMessage('assistant', responseText);

        // Show lesson plan if available
        if (plan) {
          state.currentPlan = plan;
          renderLessonPlan(plan);
          switchTab('lesplan');
        } else {
          // No lesson plan - clear and show empty state
          state.currentPlan = null;
          document.getElementById('lesplanEmpty').classList.remove('hidden');
          document.getElementById('lesplanContent').classList.add('hidden');
          // Don't switch tabs for info responses, stay on lesplan to show empty state
        }
        
        // Filter recommendations and citations by scope if set
        let filteredRecommendations = recommendations;
        let filteredCitations = citations;
        
        if (state.currentScope === 'materials' && citations) {
          // Only show citations from 'material' source
          filteredCitations = citations.filter(c => c.source === 'material');
        } else if (state.currentScope === 'mes' && citations) {
          // Only show citations from 'mes' source
          filteredCitations = citations.filter(c => c.source === 'mes');
        }
        // 'all' scope shows everything (no filtering)
        
        // Show recommendations if available, otherwise clear
        if (filteredRecommendations && filteredRecommendations.length > 0) {
          renderRecommendations(filteredRecommendations);
        } else {
          document.getElementById('materialsEmpty').classList.remove('hidden');
          document.getElementById('materialsContent').classList.add('hidden');
        }
        
        // Store original citations in state for re-filtering
        state.currentCitations = citations;
        
        // Show citations if available, otherwise clear
        if (filteredCitations && filteredCitations.length > 0) {
          renderCitations(filteredCitations);
        } else {
          document.getElementById('sourcesEmpty').classList.remove('hidden');
          document.getElementById('sourcesContent').classList.add('hidden');
        }

        state.isLoading = false;
        document.getElementById('sendBtn').classList.remove('loading');
        document.getElementById('sendBtn').disabled = false;
        
        showToast('Antwoord gegenereerd', 'success');
      }, 2000);
    }

    function addMessage(role, content) {
      const messagesContainer = document.getElementById('chatMessages');
      const avatar = role === 'user' ? 'üë§' : '‚ú®';
      
      const messageHtml = `
        <div class="message message--${role}">
          <div class="message-avatar">${avatar}</div>
          <div class="message-content">
            <div class="message-text">${formatMarkdown(content)}</div>
          </div>
        </div>
      `;
      
      messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      state.messages.push({ role, content });
    }

    function addTypingIndicator() {
      const messagesContainer = document.getElementById('chatMessages');
      const html = `
        <div class="message message--assistant" id="typingIndicator">
          <div class="message-avatar">‚ú®</div>
          <div class="message-content">
            <div class="typing-indicator">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      `;
      messagesContainer.insertAdjacentHTML('beforeend', html);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) indicator.remove();
    }

    function formatMarkdown(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    // ========================================
    // RENDER FUNCTIONS
    // ========================================
    function renderLessonPlan(plan) {
      document.getElementById('lesplanEmpty').classList.add('hidden');
      const container = document.getElementById('lesplanContent');
      container.classList.remove('hidden');

      container.innerHTML = `
        <div class="lesson-plan-header">
          <div class="kd-badge">
            <svg class="kd-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            KD ${plan.kdAlignment.code}
          </div>
          <div class="lesson-plan-actions">
            <button class="action-btn action-btn--download" onclick="openLesplanViewer()" data-cta-id="cta-open-lesplan-viewer">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
              </svg>
              Bekijk volledig
            </button>
            <button class="action-btn" onclick="printLessonPlan()" data-cta-id="cta-print-lesplan">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6v-8z"/>
              </svg>
              Print
            </button>
            <button class="action-btn action-btn--primary" data-cta-id="cta-use-lesplan" onclick="useLessonPlan()">
              Gebruiken
            </button>
          </div>
        </div>

        <div class="plan-section quick-start open">
          <div class="plan-section-header" onclick="toggleSection(this.parentElement)">
            <div class="plan-section-title">
              <svg class="plan-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Quick Start
            </div>
            <svg class="plan-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="plan-section-content">
            <div class="quick-start-oneliner">${plan.quickStart.oneLiner}</div>
            <div class="time-allocation">
              <div class="time-block">
                <div class="time-block-label">Start</div>
                <div class="time-block-value">${plan.quickStart.timeAllocation.start} min</div>
              </div>
              <div class="time-block">
                <div class="time-block-label">Kern</div>
                <div class="time-block-value">${plan.quickStart.timeAllocation.kern} min</div>
              </div>
              <div class="time-block">
                <div class="time-block-label">Afsluiting</div>
                <div class="time-block-value">${plan.quickStart.timeAllocation.afsluiting} min</div>
              </div>
            </div>
            <div class="key-concepts">
              ${plan.quickStart.keyConcepts.map(c => `<span class="concept-tag">${c}</span>`).join('')}
            </div>
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header" onclick="toggleSection(this.parentElement)">
            <div class="plan-section-title">
              <svg class="plan-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              Docentenscript
            </div>
            <svg class="plan-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="plan-section-content">
            ${plan.teacherScript.map(s => `
              <div class="script-item">
                <div class="script-time">${s.time}</div>
                <div class="script-phase">${s.phase}</div>
                <div class="script-content"><strong>${s.action}:</strong> ${s.content}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header" onclick="toggleSection(this.parentElement)">
            <div class="plan-section-title">
              <svg class="plan-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Discussievragen
            </div>
            <svg class="plan-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="plan-section-content">
            ${plan.discussionQuestions.map(q => `
              <div class="question-item">
                <div class="question-text">${q.question}</div>
                <div class="question-answers">Verwacht: ${q.expectedAnswers.join(' ‚Ä¢ ')}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header" onclick="toggleSection(this.parentElement)">
            <div class="plan-section-title">
              <svg class="plan-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
              Groepsopdracht
            </div>
            <svg class="plan-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="plan-section-content">
            <div class="group-work-title">${plan.groupWork.title}</div>
            <div class="group-work-duration">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
              </svg>
              ${plan.groupWork.durationMinutes} minuten
            </div>
            <ol class="group-work-steps">
              ${plan.groupWork.steps.map(step => `<li>${step}</li>`).join('')}
            </ol>
          </div>
        </div>

        <div class="plan-section kd-check-section">
          <div class="plan-section-header" onclick="toggleSection(this.parentElement)">
            <div class="plan-section-title">
              <svg class="plan-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              KD-Check
            </div>
            <svg class="plan-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="plan-section-content">
            <div class="kd-check-intro">Controleer of het lesplan aansluit bij ${plan.kdAlignment.code}:</div>
            ${generateKdCheckItems(plan.kdAlignment.code)}
          </div>
        </div>
      `;

      // Switch to lesplan tab
      switchTab('lesplan');
    }

    // Generate KD-Check items based on KD code
    function generateKdCheckItems(kdCode) {
      const kdChecks = {
        'B1-K1-W2': [
          { check: true, text: 'Zorgplan opstellen/bijstellen ‚Üí Casus met veranderende situatie' },
          { check: true, text: 'Eigen regie zorgvrager ‚Üí Afstemming met zorgvrager besproken' },
          { check: true, text: 'Signaleren en analyseren ‚Üí Observatie en rapportage' },
          { check: true, text: 'SMART-doelen ‚Üí Concrete aanpassingen formuleren' },
        ],
        'B1-K1-W3': [
          { check: true, text: 'Zorginterventies uitvoeren ‚Üí Praktijkoefening opgenomen' },
          { check: true, text: 'Eigen regie stimuleren ‚Üí Toestemming vragen besproken' },
          { check: true, text: 'Veiligheid waarborgen ‚Üí Protocol en checklist gebruikt' },
          { check: true, text: 'Rapportage ‚Üí Vastleggen na handeling' },
        ],
        'B1-K1-W5': [
          { check: true, text: 'Acute situaties herkennen ‚Üí ABCDE-methodiek centraal' },
          { check: true, text: 'Alarmprocedure ‚Üí Wanneer hulp inschakelen' },
          { check: true, text: 'Veiligheid inschatten ‚Üí Gevaar voor zelf/anderen' },
          { check: true, text: 'Praktijkgericht ‚Üí Simulatieoefening' },
        ],
        'B1-K2-W2': [
          { check: true, text: 'Samenwerken met professionals ‚Üí Rollenspel MDO/overdracht' },
          { check: true, text: 'Professionele communicatie ‚Üí SBAR-structuur' },
          { check: true, text: 'Informatieoverdracht ‚Üí Telefoongesprek simulatie' },
          { check: true, text: 'Afstemmen afspraken ‚Üí Vastleggen in zorgplan' },
        ],
        'B1-K3-W2': [
          { check: true, text: 'Reflecteren op werkzaamheden ‚Üí STARR-methode' },
          { check: true, text: 'Verbeterpunten formuleren ‚Üí Concrete acties' },
          { check: true, text: 'Professionele ontwikkeling ‚Üí Portfolio/stagegesprek' },
          { check: true, text: 'Feedback ontvangen ‚Üí Peer feedback' },
        ],
      };

      const checks = kdChecks[kdCode] || [
        { check: true, text: 'Leerdoel aansluitend bij KD' },
        { check: true, text: 'Werkvormen activerend' },
        { check: true, text: 'Praktijkgericht' },
      ];

      return `
        <div class="kd-check-list">
          ${checks.map(item => `
            <div class="kd-check-item">
              <span class="kd-check-icon ${item.check ? 'checked' : ''}">${item.check ? '‚úì' : '‚óã'}</span>
              <span class="kd-check-text">${item.text}</span>
            </div>
          `).join('')}
        </div>
        <div class="kd-check-footer">
          <span class="kd-check-score">4/4 criteria voldaan</span>
          <button class="kd-check-btn" onclick="showToast('KD-alignment geverifieerd!', 'success')">Verificatie opslaan</button>
        </div>
      `;
    }

    function renderRecommendations(recommendations) {
      document.getElementById('materialsEmpty').classList.add('hidden');
      const container = document.getElementById('materialsContent');
      container.classList.remove('hidden');

      container.innerHTML = recommendations.map(r => `
        <div class="recommendation-card" data-cta-id="cta-sam-recommendation-${r.id}">
          <div class="recommendation-header">
            <div class="recommendation-title">${r.title}</div>
            <div class="recommendation-score">${(r.score * 100).toFixed(0)}%</div>
          </div>
          <div class="recommendation-meta">
            <span class="file-badge">${r.contentType}</span>
            <span class="file-badge">${r.fileName}</span>
          </div>
          <div class="recommendation-snippet">${r.snippet}</div>
          <div class="recommendation-action">
            <button class="use-btn" data-cta-id="cta-sam-recommendation-use-${r.id}" onclick="useMaterial('${r.id}', '${r.title.replace(/'/g, "\\'")}')">
              Gebruik dit materiaal
            </button>
          </div>
        </div>
      `).join('');
      
      // Show materials tab badge
      showToast(`${recommendations.length} materialen gevonden`, 'success');
    }

    function renderCitations(citations) {
      document.getElementById('sourcesEmpty').classList.add('hidden');
      const container = document.getElementById('sourcesContent');
      container.classList.remove('hidden');

      // Format matches real system: source (Material/MES), course_id, chunk item_index, similarity
      container.innerHTML = citations.map(c => {
        const sourceLabel = c.source === 'mes' ? 'MES' : 'Material';
        return `
          <div class="citation-item">
            <div class="citation-header">
              <span class="citation-source">${sourceLabel} ¬∑ ${c.course_id} ¬∑ chunk ${c.item_index}</span>
              <span class="citation-sim">sim ${c.similarity.toFixed(3)}</span>
            </div>
            <div class="citation-text">${c.text}</div>
          </div>
        `;
      }).join('');
    }

    function toggleSection(section) {
      section.classList.toggle('open');
    }

    // ========================================
    // LESSON PLAN ACTIONS
    // ========================================
    function useLessonPlan() {
      if (!state.currentPlan) {
        showToast('Geen lesplan beschikbaar', 'warning');
        return;
      }
      
      showModal(
        'Lesplan opslaan',
        `Wil je dit lesplan voor ${state.currentPlan.kdAlignment.code} opslaan in je bibliotheek? Je kunt het later terugvinden bij Lespakketten.`,
        'Opslaan',
        () => {
          showToast(`Lesplan ${state.currentPlan.kdAlignment.code} opgeslagen!`, 'success');
        }
      );
    }

    function printLessonPlan() {
      if (!state.currentPlan) {
        showToast('Geen lesplan beschikbaar om te printen', 'warning');
        return;
      }
      showToast('Lesplan wordt geprint...', 'info');
      setTimeout(() => window.print(), 300);
    }

    function openLesplanViewer() {
      if (!state.currentPlan) {
        showToast('Geen lesplan beschikbaar', 'warning');
        return;
      }
      
      const plan = state.currentPlan;
      const today = new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' });
      
      // Generate the HTML content
      const htmlContent = generateLesplanHTML(plan, today);
      
      // Open in new window
      const newWindow = window.open('', '_blank');
      newWindow.document.write(htmlContent);
      newWindow.document.close();
      
      showToast('Lesplan geopend in nieuw tabblad', 'success');
    }
    
    function generateLesplanHTML(plan, today) {
      // Get detailed method content based on KD code
      let methodContent = '';
      const kdCode = plan.kdAlignment.code;
      
      if (kdCode === 'B1-K1-W5' && demoABCDE.detailedContent) {
        methodContent = generateABCDEContent(demoABCDE.detailedContent.ABCDE);
      } else if (kdCode === 'B1-K2-W2' && demoSamenwerking.detailedContent) {
        methodContent = generateSBARContent(demoSamenwerking.detailedContent.SBAR);
      } else if (kdCode === 'B1-K3-W2' && demoReflectie.detailedContent) {
        methodContent = generateSTARRContent(demoReflectie.detailedContent.STARR);
      } else if (kdCode === 'B1-K1-W2' && demoLessonPlan.detailedContent) {
        methodContent = generateSMARTContent(demoLessonPlan.detailedContent.SMART, demoLessonPlan.detailedContent.klinischRedeneren);
      } else if (kdCode === 'B1-K1-W3' && demoZorginterventies.detailedContent) {
        methodContent = generateZorgContent(demoZorginterventies.detailedContent);
      }
      
      return `<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesplan ${plan.kdAlignment.code} - e-Xpert SAM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #22c55e;
      --warning: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .header-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .header-subtitle {
      opacity: 0.9;
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    
    .header-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .btn-primary {
      background: white;
      color: var(--primary);
    }
    
    .btn-primary:hover {
      background: var(--gray-100);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .toc {
      background: white;
      border-radius: 12px;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .toc h2 {
      font-size: 1rem;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }
    
    .toc-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 0.5rem;
      list-style: none;
    }
    
    .toc-list a {
      color: var(--primary);
      text-decoration: none;
      padding: 0.5rem;
      border-radius: 6px;
      display: block;
      transition: background 0.2s;
    }
    
    .toc-list a:hover {
      background: var(--gray-100);
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .section h2 {
      font-size: 1.25rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--gray-100);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .section h2 .number {
      background: var(--primary);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
    }
    
    .section h3 {
      font-size: 1rem;
      color: var(--gray-700);
      margin: 1.5rem 0 0.75rem;
    }
    
    .quick-start-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .quick-start-card {
      background: var(--gray-50);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    
    .quick-start-card .time {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .quick-start-card .label {
      font-size: 0.85rem;
      color: var(--gray-500);
    }
    
    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .keyword {
      background: var(--primary);
      color: white;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .script-item {
      border-left: 3px solid var(--primary);
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      background: var(--gray-50);
      border-radius: 0 8px 8px 0;
    }
    
    .script-item.phase-start { border-left-color: var(--success); }
    .script-item.phase-kern { border-left-color: var(--primary); }
    .script-item.phase-afsluiting { border-left-color: var(--warning); }
    
    .script-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .script-time {
      background: var(--gray-200);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .script-phase {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
    }
    
    .script-action {
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .script-content {
      color: var(--gray-700);
      font-size: 0.95rem;
    }
    
    .question-card {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    
    .question-card h4 {
      color: var(--gray-900);
      margin-bottom: 0.75rem;
    }
    
    .question-card ul {
      margin-left: 1.25rem;
      color: var(--gray-600);
    }
    
    .question-card li {
      margin-bottom: 0.25rem;
    }
    
    .assignment-box {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd;
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .assignment-box h3 {
      color: var(--primary);
      margin-top: 0;
    }
    
    .assignment-box ol {
      margin-left: 1.25rem;
      margin-top: 1rem;
    }
    
    .assignment-box li {
      margin-bottom: 0.5rem;
    }
    
    .kd-check {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    
    .kd-check-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #f0fdf4;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .kd-check-item .check {
      color: var(--success);
      font-size: 1.1rem;
    }
    
    .method-section {
      background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
      border: 1px solid #fde047;
      border-radius: 12px;
      padding: 2rem;
      margin-top: 2rem;
    }
    
    .method-section h2 {
      color: #854d0e;
      border-bottom-color: #fde047;
    }
    
    .method-letter {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .method-letter h3 {
      color: var(--primary);
      font-size: 1.1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .method-letter h3 .letter {
      background: var(--primary);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    
    .method-letter h4 {
      font-size: 0.9rem;
      color: var(--gray-700);
      margin: 1rem 0 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .method-letter ul {
      margin-left: 1.25rem;
      color: var(--gray-600);
    }
    
    .method-letter li {
      margin-bottom: 0.25rem;
    }
    
    .normal-values {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .normal-values h4 {
      color: #166534;
      margin-bottom: 0.5rem;
    }
    
    .normal-values ul {
      margin-left: 1.25rem;
      color: #166534;
    }
    
    .footer {
      text-align: center;
      padding: 2rem;
      color: var(--gray-500);
      font-size: 0.85rem;
    }
    
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }
    
    .modal label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }
    
    .modal input, .modal select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    
    .modal input:focus, .modal select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    
    .modal-actions .btn {
      flex: 1;
    }
    
    .btn-cancel {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    
    .btn-save {
      background: var(--primary);
      color: white;
    }
    
    .btn-save:hover {
      background: var(--primary-dark);
    }
    
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-900);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    @media print {
      .header { position: static; box-shadow: none; }
      .header-actions { display: none; }
      .section { break-inside: avoid; box-shadow: none; border: 1px solid var(--gray-200); }
      .toc { display: none; }
      body { background: white; }
    }
    
    @media (max-width: 600px) {
      .header-content { flex-direction: column; align-items: flex-start; }
      .quick-start-grid { grid-template-columns: 1fr; }
      .kd-check { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div>
        <h1>üìö Docentenhandleiding</h1>
        <div class="header-subtitle">${plan.kdAlignment.code} - ${plan.kdAlignment.title}</div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.print()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
            <rect x="6" y="14" width="12" height="8"/>
          </svg>
          Print
        </button>
        <button class="btn btn-primary" onclick="openSaveModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
            <path d="M17 21v-8H7v8M7 3v5h8"/>
          </svg>
          Opslaan in Mijn lesplannen
        </button>
      </div>
    </div>
  </header>
  
  <div class="container">
    <nav class="toc">
      <h2>Inhoudsopgave</h2>
      <ul class="toc-list">
        <li><a href="#quickstart">1. Quick Start</a></li>
        <li><a href="#lesopbouw">2. Lesopbouw</a></li>
        <li><a href="#script">3. Docentenscript</a></li>
        <li><a href="#discussie">4. Discussievragen</a></li>
        <li><a href="#opdracht">5. Groepsopdracht</a></li>
        <li><a href="#kd">6. KD-verantwoording</a></li>
        <li><a href="#methode">7. Methodische uitwerking</a></li>
      </ul>
    </nav>
    
    <section class="section" id="quickstart">
      <h2><span class="number">1</span> Quick Start - Snelle Voorbereiding</h2>
      <p style="font-size: 1.05rem; color: var(--gray-700); margin-bottom: 1.5rem;">
        <strong>Kern van de les:</strong> ${plan.quickStart.oneLiner}
      </p>
      <div class="quick-start-grid">
        <div class="quick-start-card">
          <div class="time">${plan.quickStart.timeAllocation.start}</div>
          <div class="label">min. Start</div>
        </div>
        <div class="quick-start-card">
          <div class="time">${plan.quickStart.timeAllocation.kern}</div>
          <div class="label">min. Kern</div>
        </div>
        <div class="quick-start-card">
          <div class="time">${plan.quickStart.timeAllocation.afsluiting}</div>
          <div class="label">min. Afsluiting</div>
        </div>
      </div>
      <h3>Kernbegrippen</h3>
      <div class="keywords">
        ${plan.quickStart.keyConcepts.map(k => `<span class="keyword">${k}</span>`).join('')}
      </div>
    </section>
    
    <section class="section" id="lesopbouw">
      <h2><span class="number">2</span> Lesopbouw en Tijdsindeling</h2>
      <p>Deze les is opgebouwd volgens het activerende directe instructiemodel:</p>
      <div style="margin-top: 1rem; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: var(--gray-100);">
              <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Fase</th>
              <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Tijd</th>
              <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Doel</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-100);">Start</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-100);">${plan.quickStart.timeAllocation.start} minuten</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-100);">Activeren voorkennis, verbinden met praktijk</td>
            </tr>
            <tr>
              <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-100);">Kern</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-100);">${plan.quickStart.timeAllocation.kern} minuten</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-100);">Instructie, demonstratie en oefenen</td>
            </tr>
            <tr>
              <td style="padding: 0.75rem;">Afsluiting</td>
              <td style="padding: 0.75rem;">${plan.quickStart.timeAllocation.afsluiting} minuten</td>
              <td style="padding: 0.75rem;">Reflectie, samenvatten, vooruitblik</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    
    <section class="section" id="script">
      <h2><span class="number">3</span> Docentenscript - Stap voor stap</h2>
      ${plan.teacherScript.map(item => `
        <div class="script-item phase-${item.phase.toLowerCase()}">
          <div class="script-header">
            <span class="script-time">${item.time}</span>
            <span class="script-phase">${item.phase}</span>
            <span class="script-action">${item.action}</span>
          </div>
          <div class="script-content">${item.content}</div>
        </div>
      `).join('')}
    </section>
    
    <section class="section" id="discussie">
      <h2><span class="number">4</span> Discussievragen met Verwachte Antwoorden</h2>
      ${plan.discussionQuestions.map((q, i) => `
        <div class="question-card">
          <h4>Vraag ${i + 1}: ${q.question}</h4>
          <ul>
            ${q.expectedAnswers.map(a => `<li>${a}</li>`).join('')}
          </ul>
        </div>
      `).join('')}
      <p style="color: var(--gray-500); font-style: italic; margin-top: 1rem;">
        üí° Tip: Laat studenten eerst in duo's overleggen voordat je klassikaal bespreekt.
      </p>
    </section>
    
    <section class="section" id="opdracht">
      <h2><span class="number">5</span> Groepsopdracht</h2>
      <div class="assignment-box">
        <h3>üìã ${plan.groupWork.title}</h3>
        <p><strong>Duur:</strong> ${plan.groupWork.durationMinutes} minuten</p>
        <ol>
          ${plan.groupWork.steps.map(s => `<li>${s}</li>`).join('')}
        </ol>
      </div>
    </section>
    
    <section class="section" id="kd">
      <h2><span class="number">6</span> KD-verantwoording</h2>
      <p style="margin-bottom: 1rem;">Dit lesplan sluit aan bij:</p>
      <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <strong>Kwalificatiedossier:</strong> VIG/VP 2026<br>
        <strong>Werkproces:</strong> ${plan.kdAlignment.code}<br>
        <strong>Titel:</strong> ${plan.kdAlignment.title}
      </div>
      <h3>Criteria check</h3>
      <div class="kd-check">
        ${(plan.kdAlignment.criteria || plan.quickStart.keyConcepts || []).map(c => `
          <div class="kd-check-item">
            <span class="check">‚úì</span>
            <span>${c}</span>
          </div>
        `).join('')}
      </div>
    </section>
    
    ${methodContent}
    
    <footer class="footer">
      <p>Gegenereerd door <strong>e-Xpert SAM</strong> | ${today}</p>
      <p style="margin-top: 0.5rem;">¬© ${new Date().getFullYear()} - Koning Willem 1 College</p>
    </footer>
  </div>
  
  <div class="modal-overlay" id="saveModal" onclick="closeSaveModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>üíæ Lesplan opslaan</h3>
      <p style="color: var(--gray-500); margin-bottom: 1.5rem;">Sla dit lesplan op in je persoonlijke bibliotheek.</p>
      
      <label for="lesplanName">Naam lesplan</label>
      <input type="text" id="lesplanName" value="${plan.kdAlignment.code} - ${plan.kdAlignment.title}" />
      
      <label for="classSelect">Klas (optioneel)</label>
      <select id="classSelect">
        <option value="">-- Selecteer een klas --</option>
        <option value="vp4a">VP4A - Verpleegkunde jaar 4</option>
        <option value="vp4b">VP4B - Verpleegkunde jaar 4</option>
        <option value="vig3a">VIG3A - Verzorgende IG jaar 3</option>
        <option value="vig3b">VIG3B - Verzorgende IG jaar 3</option>
      </select>
      
      <label for="notesInput">Notities (optioneel)</label>
      <input type="text" id="notesInput" placeholder="bijv. 'Aangepast voor blok 2'" />
      
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeSaveModal()">Annuleren</button>
        <button class="btn btn-save" onclick="saveLesplan()">Opslaan</button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    function openSaveModal() {
      document.getElementById('saveModal').classList.add('active');
    }
    
    function closeSaveModal(event) {
      if (!event || event.target === event.currentTarget) {
        document.getElementById('saveModal').classList.remove('active');
      }
    }
    
    function saveLesplan() {
      const name = document.getElementById('lesplanName').value;
      const classId = document.getElementById('classSelect').value;
      const notes = document.getElementById('notesInput').value;
      
      // Mock save - in real implementation this would call the API
      console.log('Saving lesplan:', { name, classId, notes });
      
      closeSaveModal();
      showToast('‚úì Lesplan opgeslagen in "Mijn lesplannen"');
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSaveModal();
    });
  <\/script>
</body>
</html>`;
    }
    
    function generateABCDEContent(abcde) {
      return `
    <section class="section method-section" id="methode">
      <h2><span class="number">7</span> De ABCDE-Methode - Uitgebreide Uitleg</h2>
      <p style="margin-bottom: 1.5rem;">De ABCDE-methode is een systematische aanpak voor acute situaties. Je werkt ALTIJD in deze volgorde omdat je eerst de meest levensbedreigende problemen aanpakt.</p>
      
      <div class="method-letter">
        <h3><span class="letter">A</span> Airway (Luchtweg)</h3>
        <p>${abcde.A.explanation}</p>
        <h4>Mogelijke oorzaken</h4>
        <ul>${abcde.A.causes.map(c => `<li>${c}</li>`).join('')}</ul>
        <h4>Wat observeer je?</h4>
        <ul>${abcde.A.observations.map(o => `<li>${o}</li>`).join('')}</ul>
        <h4>Directe acties</h4>
        <ul>${abcde.A.actions.map(a => `<li>${a}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">B</span> Breathing (Ademhaling)</h3>
        <p>${abcde.B.explanation}</p>
        <h4>Mogelijke oorzaken</h4>
        <ul>${abcde.B.causes.map(c => `<li>${c}</li>`).join('')}</ul>
        <h4>Wat meet je?</h4>
        <ul>${abcde.B.observations.map(o => `<li>${o}</li>`).join('')}</ul>
        <h4>Directe acties</h4>
        <ul>${abcde.B.actions.map(a => `<li>${a}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">C</span> Circulation (Bloedsomloop)</h3>
        <p>${abcde.C.explanation}</p>
        <h4>Mogelijke oorzaken</h4>
        <ul>${abcde.C.causes.map(c => `<li>${c}</li>`).join('')}</ul>
        <h4>Wat meet je?</h4>
        <ul>${abcde.C.observations.map(o => `<li>${o}</li>`).join('')}</ul>
        <h4>Directe acties</h4>
        <ul>${abcde.C.actions.map(a => `<li>${a}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">D</span> Disability (Neurologisch)</h3>
        <p>${abcde.D.explanation}</p>
        <h4>Mogelijke oorzaken</h4>
        <ul>${abcde.D.causes.map(c => `<li>${c}</li>`).join('')}</ul>
        <h4>Wat meet je?</h4>
        <ul>${abcde.D.observations.map(o => `<li>${o}</li>`).join('')}</ul>
        <h4>Directe acties</h4>
        <ul>${abcde.D.actions.map(a => `<li>${a}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">E</span> Exposure (Volledig onderzoek)</h3>
        <p>${abcde.E.explanation}</p>
        <h4>Wat doe je?</h4>
        <ul>${abcde.E.observations.map(o => `<li>${o}</li>`).join('')}</ul>
        <h4>Directe acties</h4>
        <ul>${abcde.E.actions.map(a => `<li>${a}</li>`).join('')}</ul>
      </div>
      
      <div class="normal-values">
        <h4>üìä Normaalwaarden om te onthouden</h4>
        <ul>
          <li>Ademfrequentie: 12-20 per minuut</li>
          <li>Saturatie: boven 94%</li>
          <li>Hartfrequentie: 60-100 per minuut</li>
          <li>Bloeddruk: boven 100 systolisch</li>
          <li>Capillaire refill: onder 2 seconden</li>
          <li>AVPU: Alert is normaal</li>
        </ul>
      </div>
    </section>`;
    }
    
    function generateSBARContent(sbar) {
      return `
    <section class="section method-section" id="methode">
      <h2><span class="number">7</span> De SBAR-Methode - Uitgebreide Uitleg</h2>
      <p style="margin-bottom: 1.5rem;">SBAR is een gestructureerde communicatiemethode voor effectieve overdracht tussen zorgprofessionals.</p>
      
      <div class="method-letter">
        <h3><span class="letter">S</span> Situation (Situatie)</h3>
        <p>${sbar.S.explanation}</p>
        <h4>Format</h4>
        <p style="background: var(--gray-50); padding: 1rem; border-radius: 6px; font-style: italic;">${sbar.S.format}</p>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">B</span> Background (Achtergrond)</h3>
        <p>${sbar.B.explanation}</p>
        <h4>Format</h4>
        <p style="background: var(--gray-50); padding: 1rem; border-radius: 6px; font-style: italic;">${sbar.B.format}</p>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">A</span> Assessment (Beoordeling)</h3>
        <p>${sbar.A.explanation}</p>
        <h4>Format</h4>
        <p style="background: var(--gray-50); padding: 1rem; border-radius: 6px; font-style: italic;">${sbar.A.format}</p>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">R</span> Recommendation (Aanbeveling)</h3>
        <p>${sbar.R.explanation}</p>
        <h4>Format</h4>
        <p style="background: var(--gray-50); padding: 1rem; border-radius: 6px; font-style: italic;">${sbar.R.format}</p>
      </div>
    </section>`;
    }
    
    function generateSTARRContent(starr) {
      return `
    <section class="section method-section" id="methode">
      <h2><span class="number">7</span> De STARR-Methode - Uitgebreide Uitleg</h2>
      <p style="margin-bottom: 1.5rem;">STARR is een reflectiemethode die je helpt om gestructureerd te leren van je ervaringen.</p>
      
      <div class="method-letter">
        <h3><span class="letter">S</span> Situatie</h3>
        <p>${starr.S.explanation}</p>
        <h4>Hulpvragen</h4>
        <ul>${starr.S.helpQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">T</span> Taak</h3>
        <p>${starr.T.explanation}</p>
        <h4>Hulpvragen</h4>
        <ul>${starr.T.helpQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">A</span> Actie</h3>
        <p>${starr.A.explanation}</p>
        <h4>Hulpvragen</h4>
        <ul>${starr.A.helpQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">R</span> Resultaat</h3>
        <p>${starr.R1.explanation}</p>
        <h4>Hulpvragen</h4>
        <ul>${starr.R1.helpQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">R</span> Reflectie</h3>
        <p>${starr.R2.explanation}</p>
        <h4>Hulpvragen</h4>
        <ul>${starr.R2.helpQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
      </div>
    </section>`;
    }
    
    function generateSMARTContent(smart, klinisch) {
      return `
    <section class="section method-section" id="methode">
      <h2><span class="number">7</span> SMART Doelen - Uitgebreide Uitleg</h2>
      <p style="margin-bottom: 1.5rem;">SMART-criteria helpen bij het formuleren van concrete, meetbare zorgdoelen.</p>
      
      <div class="method-letter">
        <h3><span class="letter">S</span> Specifiek</h3>
        <p>${smart.S.explanation}</p>
        <p style="background: #fee2e2; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚ùå Fout:</strong> ${smart.S.wrongExample}</p>
        <p style="background: #dcfce7; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚úì Goed:</strong> ${smart.S.correctExample}</p>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">M</span> Meetbaar</h3>
        <p>${smart.M.explanation}</p>
        <p style="background: #fee2e2; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚ùå Fout:</strong> ${smart.M.wrongExample}</p>
        <p style="background: #dcfce7; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚úì Goed:</strong> ${smart.M.correctExample}</p>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">A</span> Acceptabel</h3>
        <p>${smart.A.explanation}</p>
        <p style="background: #fee2e2; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚ùå Fout:</strong> ${smart.A.wrongExample}</p>
        <p style="background: #dcfce7; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚úì Goed:</strong> ${smart.A.correctExample}</p>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">R</span> Realistisch</h3>
        <p>${smart.R.explanation}</p>
        <p style="background: #fee2e2; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚ùå Fout:</strong> ${smart.R.wrongExample}</p>
        <p style="background: #dcfce7; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚úì Goed:</strong> ${smart.R.correctExample}</p>
      </div>
      
      <div class="method-letter">
        <h3><span class="letter">T</span> Tijdgebonden</h3>
        <p>${smart.T.explanation}</p>
        <p style="background: #fee2e2; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚ùå Fout:</strong> ${smart.T.wrongExample}</p>
        <p style="background: #dcfce7; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;"><strong>‚úì Goed:</strong> ${smart.T.correctExample}</p>
      </div>
      
      ${klinisch ? `
      <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Klinisch Redeneren - 5-Stappen Cyclus</h3>
      <div class="method-letter">
        <ol style="margin-left: 1.5rem;">
          ${klinisch.stappen.map(s => `<li style="margin-bottom: 0.75rem;"><strong>${s.stap}:</strong> ${s.beschrijving}<br><em style="color: var(--gray-500);">Voorbeeld: ${s.voorbeeld}</em></li>`).join('')}
        </ol>
      </div>
      ` : ''}
    </section>`;
    }
    
    function generateZorgContent(content) {
      return `
    <section class="section method-section" id="methode">
      <h2><span class="number">7</span> Zorginterventies - Uitgebreide Uitleg</h2>
      
      ${content.handhygiene ? `
      <div class="method-letter">
        <h3>üß¥ Handhygi√´ne - 6-Stappen Methode</h3>
        <ol style="margin-left: 1.5rem;">
          ${content.handhygiene.stappen.map(s => `<li style="margin-bottom: 0.5rem;">${s}</li>`).join('')}
        </ol>
        <div class="normal-values" style="margin-top: 1rem;">
          <h4>‚è±Ô∏è Wanneer?</h4>
          <p>${content.handhygiene.momenten}</p>
        </div>
      </div>
      ` : ''}
      
      ${content.protocolBloeddruk ? `
      <div class="method-letter">
        <h3>üíâ Protocol Bloeddrukmeting</h3>
        <h4>Voorbereiding</h4>
        <ul>${content.protocolBloeddruk.voorbereiding.map(v => `<li>${v}</li>`).join('')}</ul>
        <h4>Uitvoering</h4>
        <ol style="margin-left: 1.5rem;">${content.protocolBloeddruk.uitvoering.map(u => `<li>${u}</li>`).join('')}</ol>
        <h4>Normaalwaarden</h4>
        <ul>${content.protocolBloeddruk.normaalwaarden.map(n => `<li>${n}</li>`).join('')}</ul>
      </div>
      ` : ''}
      
      ${content.ADLcategorie√´n ? `
      <div class="method-letter">
        <h3>üè† ADL-categorie√´n</h3>
        <ul>${content.ADLcategorie√´n.map(a => `<li>${a}</li>`).join('')}</ul>
      </div>
      ` : ''}
      
      ${content.eigenRegie ? `
      <div class="method-letter">
        <h3>ü§ù Eigen Regie van de Zorgvrager</h3>
        <p>${content.eigenRegie.definitie}</p>
        <h4>Hoe stimuleer je dit?</h4>
        <ul>${content.eigenRegie.hoe.map(h => `<li>${h}</li>`).join('')}</ul>
      </div>
      ` : ''}
    </section>`;
    }
    
    // Keep the old function name as alias for backward compatibility
    // ========================================
    // MATERIAL ACTIONS (kept for compatibility)
    // ========================================
    // Legacy alias
    function downloadHandleiding() { openLesplanViewer(); }
    
    // Old downloadHandleiding code removed - now uses openLesplanViewer()
    
    // ========================================
    // MATERIAL ACTIONS
    // ========================================
    function useMaterial(materialId, materialTitle) {
      state.selectedMaterial = { id: materialId, title: materialTitle };
      
      showModal(
        'Materiaal gebruiken',
        `Wil je "${materialTitle}" toevoegen aan je huidige les? Het materiaal wordt gekoppeld aan het lesplan.`,
        'Toevoegen',
        () => {
          showToast(`"${materialTitle}" toegevoegd aan les`, 'success');
          
          // Visual feedback on the card
          const card = document.querySelector(`[data-cta-id="cta-sam-recommendation-${materialId}"]`);
          if (card) {
            card.style.borderColor = 'var(--success)';
            card.style.background = 'rgba(34, 197, 94, 0.1)';
          }
        }
      );
    }

    // ========================================
    // SCOPE TOGGLE
    // ========================================
    document.querySelectorAll('.scope-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        handleScopeChange(btn.dataset.scope);
      });
    });

    // ========================================
    // KEYBOARD SHORTCUTS
    // ========================================
    document.addEventListener('keydown', (e) => {
      // Escape to close modal
      if (e.key === 'Escape') {
        closeModal();
      }
      
      // Ctrl/Cmd + Enter to send message
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        sendMessage();
      }
    });

    // ========================================
    // SCROLL TO BOTTOM ON LOAD IF MESSAGES EXIST
    // ========================================
    window.addEventListener('load', () => {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // ========================================
    // FOLLOW-UP RESPONSES
    // ========================================
    const followUpResponses = [
      "Geen probleem! Wil je dat ik nog een **variatie** maak met een andere werkvorm?",
      "Zeker! Ik kan ook een **aangepaste versie** maken voor 30 of 90 minuten. Wat heeft je voorkeur?",
      "Goed idee! Wil je dat ik de **moeilijkheidsgraad** aanpas voor niveau 3 of niveau 4?",
      "Natuurlijk! Ik kan ook een **PowerPoint-opzet** genereren op basis van dit lesplan.",
      "Prima! Wil je dat ik een **toetsvorm** toevoeg die past bij dit onderwerp?",
      "Tuurlijk! Ik kan de **casus** aanpassen naar een andere setting (thuiszorg, ziekenhuis, GGZ).",
      "Ik kan ook extra **differentiatiemateriaal** toevoegen voor snelle en langzame leerlingen.",
      "Zal ik een **handout** maken die studenten kunnen gebruiken tijdens de les?",
      "Wil je dat ik **beoordelingscriteria** toevoeg voor de groepsopdracht?",
      "Ik kan ook een **reflectieformulier** maken dat studenten na de les kunnen invullen.",
      "Zal ik een **voorbereidingsopdracht** toevoegen die studenten thuis kunnen doen?",
      "Wil je dat ik de les **interactiever** maak met meer activerende werkvormen?"
    ];

    let followUpIndex = 0;

    function getFollowUpResponse() {
      const response = followUpResponses[followUpIndex % followUpResponses.length];
      followUpIndex++;
      return response;
    }

    // Override sendMessage for follow-up handling
    const originalSendMessage = sendMessage;
    sendMessage = function() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      
      // If we already have a conversation and this is a short follow-up
      if (state.messages.length > 0 && text.length < 50 && !text.toLowerCase().includes('lesplan')) {
        if (!text || state.isLoading) return;
        
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.remove();
        document.getElementById('suggestionChips').classList.add('hidden');
        
        addMessage('user', text);
        input.value = '';
        
        state.isLoading = true;
        document.getElementById('sendBtn').classList.add('loading');
        document.getElementById('sendBtn').disabled = true;
        addTypingIndicator();
        
        setTimeout(() => {
          removeTypingIndicator();
          addMessage('assistant', getFollowUpResponse());
          state.isLoading = false;
          document.getElementById('sendBtn').classList.remove('loading');
          document.getElementById('sendBtn').disabled = false;
        }, 1500);
        
        return;
      }
      
      // Otherwise use original logic
      originalSendMessage.call(this);
    };

    // ========================================
    // DEMO MODE: Test all features
    // ========================================
    function runDemo() {
      console.log('Starting demo mode...');
      
      // Clear first
      clearChat();
      
      // Wait a bit then send first message
      setTimeout(() => {
        document.getElementById('chatInput').value = 'Hoe leer ik studenten een zorgplan bijstellen als de situatie verandert?';
        sendMessage();
      }, 500);
    }

    function runDemoError() {
      console.log('Simulating error state...');
      showError('TeacherGPT chat failed: OPENAI_API_KEY is niet geconfigureerd. Neem contact op met de beheerder.');
    }

    function runDemoSettings() {
      console.log('Opening settings with pre-selection...');
      if (!state.settingsOpen) {
        toggleSettings();
      }
      setTimeout(() => {
        handleMaterialChange('mat-abcde-1');
        document.getElementById('materialSelect').value = 'mat-abcde-1';
      }, 300);
    }

    // Expose demo functions globally
    window.runDemo = runDemo;
    window.runDemoError = runDemoError;
    window.runDemoSettings = runDemoSettings;

    // Console instructions
    console.log('%c e-Xpert SAM Mockup ', 'background: #2563eb; color: white; padding: 4px 8px; border-radius: 4px;');
    console.log('Demo commands:');
    console.log('  runDemo()         - Auto-run lesson plan demo');
    console.log('  runDemoError()    - Show error state');
    console.log('  runDemoSettings() - Open settings with material selection');
    console.log('');
    console.log('Or click any suggestion chip to try different queries');
    
    // Debug: Verify functions are defined
    console.log('Functions loaded:', {
      sendMessage: typeof sendMessage,
      handleInputKeydown: typeof handleInputKeydown,
      addMessage: typeof addMessage
    });
    
    // Add event listeners as backup
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners');
      
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      
      if (input) {
        console.log('Chat input found');
        input.addEventListener('keydown', function(e) {
          console.log('Keydown event:', e.key);
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            console.log('Enter pressed, calling sendMessage');
            sendMessage();
          }
        });
      } else {
        console.error('Chat input NOT found!');
      }
      
      if (sendBtn) {
        console.log('Send button found');
        sendBtn.addEventListener('click', function() {
          console.log('Send button clicked');
          sendMessage();
        });
      } else {
        console.error('Send button NOT found!');
      }
    });
  </script>
</body>
</html>
