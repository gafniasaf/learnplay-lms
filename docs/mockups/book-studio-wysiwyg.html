<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Studio WYSIWYG Editor</title>
  <link rel="stylesheet" href="_base.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== BOOK STUDIO SPECIFIC STYLES ===== */
    
    /* Book Design Tokens (simulating design_tokens.json) */
    :root {
      --book-page-width: 8.5in;
      --book-page-height: 11in;
      --book-margin-top: 0.75in;
      --book-margin-bottom: 0.75in;
      --book-margin-inner: 0.875in;
      --book-margin-outer: 0.625in;
      --book-font-body: 'Crimson Pro', Georgia, serif;
      --book-font-heading: 'Montserrat', Arial, sans-serif;
      --book-font-size: 11pt;
      --book-line-height: 1.6;
      --book-color-primary: #1a365d;
      --book-color-accent: #d97706;
      --book-color-text: #1f2937;
      --book-color-muted: #6b7280;
      
      /* Editor Chrome */
      --sidebar-width: 260px;
      --header-height: 52px;
      --footer-height: 40px;
    }

    /* Layout */
    .studio-layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .studio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--header-height);
      padding: 0 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      gap: 16px;
    }

    .studio-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      flex: 1;
    }

    .studio-header-title {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .studio-header-subtitle {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .studio-header-center {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .studio-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chapter-select {
      padding: 6px 12px;
      font-size: var(--text-sm);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      cursor: pointer;
      min-width: 180px;
    }

    .chapter-select:hover {
      border-color: var(--border-focus);
    }

    .zoom-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }

    .zoom-control input[type="range"] {
      width: 80px;
      accent-color: var(--accent-gold);
    }

    .zoom-value {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      min-width: 40px;
      text-align: center;
    }

    .unsaved-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      font-size: var(--text-xs);
      color: var(--warning);
      background: var(--warning-muted);
      border-radius: var(--radius-sm);
    }

    .unsaved-dot {
      width: 6px;
      height: 6px;
      background: var(--warning);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    /* Main Content Area */
    .studio-main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .studio-sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .nav-section {
      margin-bottom: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: var(--text-sm);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--accent-gold-muted);
      color: var(--accent-gold);
    }

    .nav-item.has-changes::after {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--warning);
      border-radius: 50%;
      margin-left: auto;
    }

    .nav-item-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .nav-item-label {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-item-indent {
      padding-left: 28px;
    }

    .nav-item-indent-2 {
      padding-left: 44px;
    }

    .nav-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: transform var(--transition-fast);
    }

    .nav-toggle.expanded {
      transform: rotate(90deg);
    }

    /* Canvas Viewport */
    .canvas-viewport {
      flex: 1;
      overflow: auto;
      background: #3a3a4a;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
    }

    .canvas-viewport.zoom-50 .book-page { transform: scale(0.5); transform-origin: top center; }
    .canvas-viewport.zoom-75 .book-page { transform: scale(0.75); transform-origin: top center; }
    .canvas-viewport.zoom-100 .book-page { transform: scale(1); }
    .canvas-viewport.zoom-125 .book-page { transform: scale(1.25); transform-origin: top center; }
    .canvas-viewport.zoom-150 .book-page { transform: scale(1.5); transform-origin: top center; }
    .canvas-viewport.zoom-200 .book-page { transform: scale(2); transform-origin: top center; }

    /* Book Page */
    .book-page {
      width: var(--book-page-width);
      min-height: var(--book-page-height);
      background: white;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
      font-family: var(--book-font-body);
      font-size: var(--book-font-size);
      line-height: var(--book-line-height);
      color: var(--book-color-text);
      position: relative;
      flex-shrink: 0;
    }

    .book-page-content {
      padding: var(--book-margin-top) var(--book-margin-outer) var(--book-margin-bottom) var(--book-margin-inner);
    }

    .book-page.right-page .book-page-content {
      padding: var(--book-margin-top) var(--book-margin-inner) var(--book-margin-bottom) var(--book-margin-outer);
    }

    /* Page Types */
    .book-page.cover-page {
      background: linear-gradient(135deg, var(--book-color-primary) 0%, #2d4a7c 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
    }

    .book-page.chapter-opener {
      background: linear-gradient(180deg, var(--book-color-primary) 0%, var(--book-color-primary) 40%, white 40%);
    }

    /* Cover Elements */
    .cover-image-container {
      position: relative;
      width: 80%;
      max-width: 400px;
      aspect-ratio: 4/3;
      margin-bottom: 40px;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.1);
    }

    .cover-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .cover-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
      gap: 8px;
    }

    .cover-title {
      font-family: var(--book-font-heading);
      font-size: 36pt;
      font-weight: 700;
      margin-bottom: 16px;
      max-width: 80%;
    }

    .cover-subtitle {
      font-size: 18pt;
      opacity: 0.9;
      max-width: 70%;
    }

    .cover-author {
      margin-top: 40px;
      font-size: 14pt;
      opacity: 0.8;
    }

    /* Chapter Opener Elements */
    .chapter-opener-header {
      color: white;
      padding: 60px var(--book-margin-outer) 80px var(--book-margin-inner);
      position: relative;
    }

    .chapter-number {
      font-family: var(--book-font-heading);
      font-size: 14pt;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.8;
      margin-bottom: 12px;
    }

    .chapter-title {
      font-family: var(--book-font-heading);
      font-size: 32pt;
      font-weight: 700;
      line-height: 1.2;
    }

    .chapter-opener-image {
      position: absolute;
      right: var(--book-margin-outer);
      top: 40px;
      width: 200px;
      height: 150px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .chapter-opener-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chapter-intro {
      padding: 40px var(--book-margin-outer) 40px var(--book-margin-inner);
      font-style: italic;
      color: var(--book-color-muted);
      border-left: 3px solid var(--book-color-accent);
      margin-left: 20px;
      padding-left: 20px;
    }

    /* Body Content Elements */
    .section-title {
      font-family: var(--book-font-heading);
      font-size: 16pt;
      font-weight: 600;
      color: var(--book-color-primary);
      margin-top: 24px;
      margin-bottom: 12px;
    }

    .subsection-title {
      font-family: var(--book-font-heading);
      font-size: 12pt;
      font-weight: 600;
      color: var(--book-color-text);
      margin-top: 20px;
      margin-bottom: 8px;
    }

    .paragraph {
      margin-bottom: 12px;
      text-align: justify;
      hyphens: auto;
    }

    .paragraph.first-para::first-letter {
      font-size: 3em;
      float: left;
      line-height: 0.8;
      padding-right: 8px;
      color: var(--book-color-primary);
      font-weight: 600;
    }

    /* Figure Elements */
    .figure {
      margin: 24px 0;
      position: relative;
    }

    .figure-image-container {
      position: relative;
      background: #f5f5f5;
      border-radius: 4px;
      overflow: hidden;
    }

    .figure-image {
      width: 100%;
      height: auto;
      display: block;
    }

    .figure-placeholder {
      width: 100%;
      height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 13px;
      gap: 8px;
      border: 2px dashed #ddd;
      border-radius: 4px;
      background: #fafafa;
    }

    .figure-caption {
      font-size: 10pt;
      color: var(--book-color-muted);
      margin-top: 8px;
      text-align: center;
    }

    .figure-number {
      font-weight: 600;
      color: var(--book-color-primary);
    }

    /* Editable Elements */
    .editable-text {
      outline: none;
      transition: box-shadow var(--transition-fast), background var(--transition-fast);
      border-radius: 2px;
      cursor: text;
    }

    .editable-text:hover {
      background: rgba(245, 166, 35, 0.08);
    }

    .editable-text:focus {
      background: rgba(245, 166, 35, 0.15);
      box-shadow: 0 0 0 2px var(--accent-gold);
    }

    .editable-text.dirty {
      background: rgba(251, 191, 36, 0.15);
      border-left: 3px solid var(--warning);
      padding-left: 8px;
      margin-left: -11px;
    }

    .editable-text.ai-loading {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Image Actions Overlay */
    .image-actions-container {
      position: relative;
    }

    .image-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity var(--transition-fast);
      z-index: 10;
    }

    .image-actions-container:hover .image-actions {
      opacity: 1;
    }

    .image-action-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all var(--transition-fast);
    }

    .image-action-btn:hover {
      background: var(--accent-gold);
      color: black;
      transform: scale(1.1);
    }

    .image-action-btn.loading {
      pointer-events: none;
    }

    .image-action-btn.loading::after {
      content: '';
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Text Action Buttons */
    .text-actions {
      position: absolute;
      right: -50px;
      top: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .editable-wrapper {
      position: relative;
    }

    .editable-wrapper:hover .text-actions,
    .editable-wrapper:focus-within .text-actions {
      opacity: 1;
    }

    .text-action-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
      transition: all var(--transition-fast);
    }

    .text-action-btn:hover {
      background: var(--accent-gold);
      border-color: var(--accent-gold);
      color: black;
    }

    /* Formatting Toolbar */
    .format-toolbar {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      padding: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      opacity: 0;
      transition: all var(--transition-fast);
    }

    .format-toolbar.visible {
      top: calc(var(--header-height) + 12px);
      opacity: 1;
    }

    .format-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all var(--transition-fast);
    }

    .format-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .format-btn.active {
      background: var(--accent-gold-muted);
      color: var(--accent-gold);
      border-color: var(--accent-gold);
    }

    /* Footer */
    .studio-footer {
      height: var(--footer-height);
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
    }

    .footer-left,
    .footer-center,
    .footer-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .footer-text {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .page-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .page-nav-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
      transition: all var(--transition-fast);
    }

    .page-nav-btn:hover:not(:disabled) {
      background: var(--accent-gold);
      border-color: var(--accent-gold);
      color: black;
    }

    .page-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-dot.warning {
      background: var(--warning);
      animation: pulse 1.5s infinite;
    }

    /* Modal */
    .prompt-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
    }

    .prompt-modal.open {
      opacity: 1;
      visibility: visible;
    }

    .prompt-modal-content {
      width: 100%;
      max-width: 480px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      transform: scale(0.95);
      transition: transform var(--transition-base);
    }

    .prompt-modal.open .prompt-modal-content {
      transform: scale(1);
    }

    .prompt-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .prompt-modal-title {
      font-size: var(--text-base);
      font-weight: 600;
    }

    .prompt-modal-body {
      padding: 20px;
    }

    .prompt-input {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      font-size: var(--text-sm);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      resize: vertical;
    }

    .prompt-input:focus {
      outline: none;
      border-color: var(--accent-gold);
      box-shadow: 0 0 0 3px var(--accent-gold-muted);
    }

    .prompt-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Toast Container */
    .toast-container {
      position: fixed;
      bottom: 60px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 2000;
    }

    /* Hidden file input */
    .hidden-input {
      position: absolute;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
    }

    /* Page margin guides (optional visual aid) */
    .book-page.show-guides::before {
      content: '';
      position: absolute;
      inset: var(--book-margin-top) var(--book-margin-outer) var(--book-margin-bottom) var(--book-margin-inner);
      border: 1px dashed rgba(0, 100, 255, 0.2);
      pointer-events: none;
    }

    /* Running header */
    .running-header {
      position: absolute;
      top: 0.4in;
      left: var(--book-margin-inner);
      right: var(--book-margin-outer);
      font-size: 9pt;
      color: var(--book-color-muted);
      display: flex;
      justify-content: space-between;
    }

    .running-header-left {
      font-style: italic;
    }

    .running-header-right {
      font-weight: 500;
    }

    /* Page number */
    .page-number {
      position: absolute;
      bottom: 0.4in;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10pt;
      color: var(--book-color-muted);
    }
  </style>
</head>
<body>
  <div class="studio-layout" data-route="/admin/book-studio/:bookId/wysiwyg">
    
    <!-- Header -->
    <header class="studio-header">
      <div class="studio-header-left">
        <button class="btn btn-ghost btn-sm" data-cta-id="cta-bookstudio-wysiwyg-back" data-action="navigate" title="Back to Book Detail">
          ‚Üê Back
        </button>
        <div>
          <div class="studio-header-title">Introduction to Biology</div>
          <div class="studio-header-subtitle">Level 7 ‚Ä¢ v2024.12</div>
        </div>
      </div>
      
      <div class="studio-header-center">
        <select class="chapter-select" id="chapterSelect" data-cta-id="cta-bookstudio-wysiwyg-chapter-select" data-action="navigate">
          <option value="cover">Cover</option>
          <option value="ch1" selected>Chapter 1: Cells</option>
          <option value="ch2">Chapter 2: Genetics</option>
          <option value="ch3">Chapter 3: Evolution</option>
        </select>
        
        <div class="zoom-control">
          <span style="font-size: 12px;">üîç</span>
          <input type="range" id="zoomSlider" min="50" max="200" step="25" value="100" data-cta-id="cta-bookstudio-wysiwyg-zoom" data-action="action">
          <span class="zoom-value" id="zoomValue">100%</span>
        </div>
      </div>
      
      <div class="studio-header-right">
        <div class="unsaved-indicator" id="unsavedIndicator" style="display: none;">
          <span class="unsaved-dot"></span>
          <span id="unsavedCount">3 unsaved</span>
        </div>
        
        <button class="btn btn-secondary btn-sm" data-cta-id="cta-bookstudio-wysiwyg-versions" data-action="navigate">
          üìú Versions
        </button>
        <button class="btn btn-secondary btn-sm" id="discardBtn" data-cta-id="cta-bookstudio-wysiwyg-discard" data-action="action">
          ‚Ü©Ô∏è Discard
        </button>
        <button class="btn btn-primary btn-sm" id="saveBtn" data-cta-id="cta-bookstudio-wysiwyg-save" data-action="action">
          üíæ Save
        </button>
        <button class="btn btn-secondary btn-sm" data-cta-id="cta-bookstudio-wysiwyg-render" data-action="action">
          üìÑ Render PDF
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <div class="studio-main">
      
      <!-- Sidebar -->
      <aside class="studio-sidebar">
        <div class="sidebar-header">
          <span class="sidebar-title">Structure</span>
          <button class="btn btn-ghost btn-sm" style="padding: 4px 8px; font-size: 11px;" data-cta-id="cta-bookstudio-wysiwyg-collapse-all" data-action="action">
            Collapse All
          </button>
        </div>
        
        <nav class="sidebar-nav" id="sidebarNav">
          <div class="nav-section">
            <button class="nav-item" data-page="cover" data-cta-id="cta-bookstudio-wysiwyg-nav-cover" data-action="navigate">
              <span class="nav-item-icon">üìï</span>
              <span class="nav-item-label">Cover</span>
            </button>
          </div>
          
          <div class="nav-section">
            <button class="nav-item active" data-page="ch1-opener" data-cta-id="cta-bookstudio-wysiwyg-nav-ch1" data-action="navigate">
              <button class="nav-toggle expanded" data-toggle="ch1">‚ñ∂</button>
              <span class="nav-item-label">Chapter 1: Cells</span>
            </button>
            <div id="ch1-children">
              <button class="nav-item nav-item-indent" data-page="ch1-s1" data-cta-id="cta-bookstudio-wysiwyg-nav-ch1-s1" data-action="navigate">
                <span class="nav-item-label">1.1 Cell Structure</span>
              </button>
              <button class="nav-item nav-item-indent has-changes" data-page="ch1-s2" data-cta-id="cta-bookstudio-wysiwyg-nav-ch1-s2" data-action="navigate">
                <span class="nav-item-label">1.2 Cell Membrane</span>
              </button>
              <button class="nav-item nav-item-indent" data-page="ch1-s3" data-cta-id="cta-bookstudio-wysiwyg-nav-ch1-s3" data-action="navigate">
                <span class="nav-item-label">1.3 Organelles</span>
              </button>
            </div>
          </div>
          
          <div class="nav-section">
            <button class="nav-item" data-page="ch2-opener" data-cta-id="cta-bookstudio-wysiwyg-nav-ch2" data-action="navigate">
              <button class="nav-toggle" data-toggle="ch2">‚ñ∂</button>
              <span class="nav-item-label">Chapter 2: Genetics</span>
            </button>
            <div id="ch2-children" style="display: none;">
              <button class="nav-item nav-item-indent" data-page="ch2-s1" data-cta-id="cta-bookstudio-wysiwyg-nav-ch2-s1" data-action="navigate">
                <span class="nav-item-label">2.1 DNA Structure</span>
              </button>
              <button class="nav-item nav-item-indent" data-page="ch2-s2" data-cta-id="cta-bookstudio-wysiwyg-nav-ch2-s2" data-action="navigate">
                <span class="nav-item-label">2.2 Replication</span>
              </button>
            </div>
          </div>
          
          <div class="nav-section">
            <button class="nav-item" data-page="ch3-opener" data-cta-id="cta-bookstudio-wysiwyg-nav-ch3" data-action="navigate">
              <button class="nav-toggle" data-toggle="ch3">‚ñ∂</button>
              <span class="nav-item-label">Chapter 3: Evolution</span>
            </button>
            <div id="ch3-children" style="display: none;">
              <button class="nav-item nav-item-indent" data-page="ch3-s1" data-cta-id="cta-bookstudio-wysiwyg-nav-ch3-s1" data-action="navigate">
                <span class="nav-item-label">3.1 Natural Selection</span>
              </button>
            </div>
          </div>
        </nav>
      </aside>

      <!-- Canvas Viewport -->
      <div class="canvas-viewport zoom-100" id="canvasViewport">
        
        <!-- Cover Page (hidden by default) -->
        <article class="book-page cover-page" id="page-cover" style="display: none;">
          <div class="image-actions-container cover-image-container">
            <div class="image-actions">
              <button class="image-action-btn" title="Upload Image" data-cta-id="cta-bookstudio-wysiwyg-cover-upload" data-action="action" onclick="triggerUpload('coverImage')">üñºÔ∏è</button>
              <button class="image-action-btn" title="AI Generate" data-cta-id="cta-bookstudio-wysiwyg-cover-ai" data-action="action" onclick="openPromptModal('cover')">üé®</button>
            </div>
            <img class="cover-image" id="coverImage" src="https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=800&h=600&fit=crop" alt="Book cover">
          </div>
          <div class="editable-wrapper">
            <h1 class="cover-title editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-cover-title-edit" data-action="edit" data-original="Introduction to Biology">Introduction to Biology</h1>
            <div class="text-actions">
              <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-cover-title-ai" data-action="action">‚ú®</button>
            </div>
          </div>
          <div class="editable-wrapper">
            <p class="cover-subtitle editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-cover-subtitle-edit" data-action="edit" data-original="A Comprehensive Guide for Grade 7">A Comprehensive Guide for Grade 7</p>
            <div class="text-actions">
              <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-cover-subtitle-ai" data-action="action">‚ú®</button>
            </div>
          </div>
          <p class="cover-author">Dr. Sarah Johnson</p>
          <div class="page-number">i</div>
        </article>

        <!-- Chapter 1 Opener -->
        <article class="book-page chapter-opener" id="page-ch1-opener">
          <div class="chapter-opener-header">
            <div class="chapter-number">Chapter One</div>
            <div class="editable-wrapper">
              <h1 class="chapter-title editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-ch1-title-edit" data-action="edit" data-original="Cells: The Building Blocks of Life">Cells: The Building Blocks of Life</h1>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-ch1-title-ai" data-action="action">‚ú®</button>
              </div>
            </div>
            <div class="image-actions-container chapter-opener-image">
              <div class="image-actions">
                <button class="image-action-btn" title="Upload Image" data-cta-id="cta-bookstudio-wysiwyg-ch1-opener-upload" data-action="action" onclick="triggerUpload('ch1OpenerImage')">üñºÔ∏è</button>
                <button class="image-action-btn" title="AI Generate" data-cta-id="cta-bookstudio-wysiwyg-ch1-opener-ai" data-action="action" onclick="openPromptModal('ch1-opener')">üé®</button>
              </div>
              <img id="ch1OpenerImage" src="https://images.unsplash.com/photo-1576086213369-97a306d36557?w=400&h=300&fit=crop" alt="Cell microscopy">
            </div>
          </div>
          <div class="editable-wrapper">
            <p class="chapter-intro editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-ch1-intro-edit" data-action="edit" data-original="In this chapter, we will explore the fascinating world of cells‚Äîthe fundamental units of all living organisms. From the smallest bacteria to the largest whales, every living thing is made of cells.">In this chapter, we will explore the fascinating world of cells‚Äîthe fundamental units of all living organisms. From the smallest bacteria to the largest whales, every living thing is made of cells.</p>
            <div class="text-actions">
              <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-ch1-intro-ai" data-action="action">‚ú®</button>
              <button class="text-action-btn" title="Revert" onclick="revertText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-ch1-intro-revert" data-action="action">‚Ü©Ô∏è</button>
            </div>
          </div>
          <div class="running-header">
            <span class="running-header-left">Introduction to Biology</span>
            <span class="running-header-right">Chapter 1</span>
          </div>
          <div class="page-number">1</div>
        </article>

        <!-- Chapter 1 Section 1 Body Page -->
        <article class="book-page" id="page-ch1-s1">
          <div class="running-header">
            <span class="running-header-left">Cells: The Building Blocks of Life</span>
            <span class="running-header-right">1.1 Cell Structure</span>
          </div>
          <div class="book-page-content">
            <div class="editable-wrapper">
              <h2 class="section-title editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-ch1s1-title-edit" data-action="edit" data-original="1.1 Cell Structure">1.1 Cell Structure</h2>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-ch1s1-title-ai" data-action="action">‚ú®</button>
              </div>
            </div>
            
            <div class="editable-wrapper">
              <p class="paragraph first-para editable-text" contenteditable="true" data-paragraph-id="p-ch1-s1-1" data-cta-id="cta-bookstudio-wysiwyg-para-1-edit" data-action="edit" data-original="All living organisms are composed of cells, which serve as the basic structural and functional units of life. The cell theory, one of the fundamental principles of biology, states that all living things are made of cells, cells are the basic units of structure and function, and all cells come from pre-existing cells.">All living organisms are composed of cells, which serve as the basic structural and functional units of life. The cell theory, one of the fundamental principles of biology, states that all living things are made of cells, cells are the basic units of structure and function, and all cells come from pre-existing cells.</p>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-1-ai" data-action="action">‚ú®</button>
                <button class="text-action-btn" title="Revert" onclick="revertText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-1-revert" data-action="action">‚Ü©Ô∏è</button>
              </div>
            </div>

            <figure class="figure">
              <div class="image-actions-container figure-image-container">
                <div class="image-actions">
                  <button class="image-action-btn" title="Upload Image" data-cta-id="cta-bookstudio-wysiwyg-fig1-upload" data-action="action" onclick="triggerUpload('fig1Image')">üñºÔ∏è</button>
                  <button class="image-action-btn" title="AI Generate" data-cta-id="cta-bookstudio-wysiwyg-fig1-ai" data-action="action" onclick="openPromptModal('fig1')">üé®</button>
                  <button class="image-action-btn" title="Remove" data-cta-id="cta-bookstudio-wysiwyg-fig1-remove" data-action="action" onclick="removeImage('fig1Image')">üóëÔ∏è</button>
                </div>
                <img class="figure-image" id="fig1Image" src="https://images.unsplash.com/photo-1530213786676-41ad9f7736f6?w=600&h=400&fit=crop" alt="Cell structure diagram">
              </div>
              <figcaption class="figure-caption">
                <span class="figure-number">Figure 1.1</span> 
                <span class="editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-fig1-caption-edit" data-action="edit" data-original="Basic structure of an animal cell showing major organelles.">Basic structure of an animal cell showing major organelles.</span>
              </figcaption>
            </figure>

            <div class="editable-wrapper">
              <p class="paragraph editable-text" contenteditable="true" data-paragraph-id="p-ch1-s1-2" data-cta-id="cta-bookstudio-wysiwyg-para-2-edit" data-action="edit" data-original="Cells can be broadly categorized into two types: prokaryotic cells and eukaryotic cells. Prokaryotic cells, found in bacteria and archaea, lack a membrane-bound nucleus and other organelles. Eukaryotic cells, found in plants, animals, fungi, and protists, have a true nucleus enclosed by a nuclear membrane and contain various specialized organelles.">Cells can be broadly categorized into two types: prokaryotic cells and eukaryotic cells. Prokaryotic cells, found in bacteria and archaea, lack a membrane-bound nucleus and other organelles. Eukaryotic cells, found in plants, animals, fungi, and protists, have a true nucleus enclosed by a nuclear membrane and contain various specialized organelles.</p>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-2-ai" data-action="action">‚ú®</button>
                <button class="text-action-btn" title="Revert" onclick="revertText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-2-revert" data-action="action">‚Ü©Ô∏è</button>
              </div>
            </div>

            <div class="editable-wrapper">
              <h3 class="subsection-title editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-subsec1-edit" data-action="edit" data-original="Components of the Cell">Components of the Cell</h3>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-subsec1-ai" data-action="action">‚ú®</button>
              </div>
            </div>

            <div class="editable-wrapper">
              <p class="paragraph editable-text dirty" contenteditable="true" data-paragraph-id="p-ch1-s1-3" data-cta-id="cta-bookstudio-wysiwyg-para-3-edit" data-action="edit" data-original="Every cell contains several essential components that work together to maintain life. The cell membrane, also known as the plasma membrane, serves as a protective barrier that regulates what enters and exits the cell.">Every cell contains several essential components that work together to maintain life. The cell membrane, also called the plasma membrane, acts as a selective barrier controlling the movement of substances into and out of the cell. This phospholipid bilayer is studded with proteins that facilitate transport and communication.</p>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-3-ai" data-action="action">‚ú®</button>
                <button class="text-action-btn" title="Revert" onclick="revertText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-3-revert" data-action="action">‚Ü©Ô∏è</button>
              </div>
            </div>

            <figure class="figure">
              <div class="image-actions-container figure-image-container">
                <div class="image-actions">
                  <button class="image-action-btn" title="Upload Image" data-cta-id="cta-bookstudio-wysiwyg-fig2-upload" data-action="action" onclick="triggerUpload('fig2Image')">üñºÔ∏è</button>
                  <button class="image-action-btn" title="AI Generate" data-cta-id="cta-bookstudio-wysiwyg-fig2-ai" data-action="action" onclick="openPromptModal('fig2')">üé®</button>
                </div>
                <div class="figure-placeholder" id="fig2Image">
                  <span>üì∑</span>
                  <span>Missing image: figures/cell-membrane.png</span>
                  <button class="btn btn-sm btn-secondary" onclick="openPromptModal('fig2')" data-cta-id="cta-bookstudio-wysiwyg-fig2-generate" data-action="action">Generate with AI</button>
                </div>
              </div>
              <figcaption class="figure-caption">
                <span class="figure-number">Figure 1.2</span> 
                <span class="editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-fig2-caption-edit" data-action="edit" data-original="The cell membrane structure showing the phospholipid bilayer.">The cell membrane structure showing the phospholipid bilayer.</span>
              </figcaption>
            </figure>

            <div class="editable-wrapper">
              <p class="paragraph editable-text" contenteditable="true" data-paragraph-id="p-ch1-s1-4" data-cta-id="cta-bookstudio-wysiwyg-para-4-edit" data-action="edit" data-original="The cytoplasm is the gel-like substance that fills the cell and houses all the organelles. It provides a medium for metabolic reactions and helps maintain the cell's shape. Within the cytoplasm, various organelles perform specialized functions essential for cell survival.">The cytoplasm is the gel-like substance that fills the cell and houses all the organelles. It provides a medium for metabolic reactions and helps maintain the cell's shape. Within the cytoplasm, various organelles perform specialized functions essential for cell survival.</p>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-4-ai" data-action="action">‚ú®</button>
                <button class="text-action-btn" title="Revert" onclick="revertText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-para-4-revert" data-action="action">‚Ü©Ô∏è</button>
              </div>
            </div>
          </div>
          <div class="page-number">2</div>
        </article>

        <!-- Chapter 1 Section 2 Body Page -->
        <article class="book-page right-page" id="page-ch1-s2" style="display: none;">
          <div class="running-header">
            <span class="running-header-left">Cells: The Building Blocks of Life</span>
            <span class="running-header-right">1.2 Cell Membrane</span>
          </div>
          <div class="book-page-content">
            <div class="editable-wrapper">
              <h2 class="section-title editable-text" contenteditable="true" data-cta-id="cta-bookstudio-wysiwyg-ch1s2-title-edit" data-action="edit" data-original="1.2 The Cell Membrane">1.2 The Cell Membrane</h2>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-ch1s2-title-ai" data-action="action">‚ú®</button>
              </div>
            </div>
            
            <div class="editable-wrapper">
              <p class="paragraph first-para editable-text" contenteditable="true" data-paragraph-id="p-ch1-s2-1" data-cta-id="cta-bookstudio-wysiwyg-ch1s2-para-1-edit" data-action="edit" data-original="The cell membrane is a remarkable structure that defines the boundary of every cell. Composed primarily of a phospholipid bilayer, it creates a selectively permeable barrier that allows certain molecules to pass while blocking others.">The cell membrane is a remarkable structure that defines the boundary of every cell. Composed primarily of a phospholipid bilayer, it creates a selectively permeable barrier that allows certain molecules to pass while blocking others.</p>
              <div class="text-actions">
                <button class="text-action-btn" title="AI Rewrite" onclick="aiRewriteText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-ch1s2-para-1-ai" data-action="action">‚ú®</button>
                <button class="text-action-btn" title="Revert" onclick="revertText(this.parentElement.previousElementSibling)" data-cta-id="cta-bookstudio-wysiwyg-ch1s2-para-1-revert" data-action="action">‚Ü©Ô∏è</button>
              </div>
            </div>
          </div>
          <div class="page-number">3</div>
        </article>
        
      </div>
    </div>

    <!-- Footer -->
    <footer class="studio-footer">
      <div class="footer-left">
        <div class="page-nav">
          <button class="page-nav-btn" id="prevPageBtn" title="Previous Page" data-cta-id="cta-bookstudio-wysiwyg-prev-page" data-action="navigate">‚Üê</button>
          <span class="footer-text">Page <span id="currentPage">2</span> of <span id="totalPages">24</span></span>
          <button class="page-nav-btn" id="nextPageBtn" title="Next Page" data-cta-id="cta-bookstudio-wysiwyg-next-page" data-action="navigate">‚Üí</button>
        </div>
      </div>
      
      <div class="footer-center">
        <span class="footer-text">Editing: <strong>1.1 Cell Structure</strong></span>
      </div>
      
      <div class="footer-right">
        <div class="status-indicator" id="statusIndicator">
          <span class="status-dot"></span>
          <span id="statusText">Ready</span>
        </div>
      </div>
    </footer>

    <!-- Formatting Toolbar -->
    <div class="format-toolbar" id="formatToolbar">
      <button class="format-btn" title="Bold" onclick="formatText('bold')" data-cta-id="cta-bookstudio-wysiwyg-format-bold" data-action="action"><strong>B</strong></button>
      <button class="format-btn" title="Italic" onclick="formatText('italic')" data-cta-id="cta-bookstudio-wysiwyg-format-italic" data-action="action"><em>I</em></button>
      <button class="format-btn" title="Underline" onclick="formatText('underline')" data-cta-id="cta-bookstudio-wysiwyg-format-underline" data-action="action"><u>U</u></button>
      <span style="width: 1px; background: var(--border); margin: 0 4px;"></span>
      <button class="format-btn" title="Subscript" onclick="formatText('subscript')" data-cta-id="cta-bookstudio-wysiwyg-format-sub" data-action="action">X‚ÇÇ</button>
      <button class="format-btn" title="Superscript" onclick="formatText('superscript')" data-cta-id="cta-bookstudio-wysiwyg-format-sup" data-action="action">X¬≤</button>
    </div>

    <!-- AI Prompt Modal -->
    <div class="prompt-modal" id="promptModal">
      <div class="prompt-modal-content">
        <div class="prompt-modal-header">
          <span style="font-size: 20px;">üé®</span>
          <span class="prompt-modal-title">Generate Image with AI</span>
        </div>
        <div class="prompt-modal-body">
          <textarea class="prompt-input" id="promptInput" placeholder="Describe the image you want to generate...&#10;&#10;Example: A detailed cross-section diagram of an animal cell showing the nucleus, mitochondria, endoplasmic reticulum, and other organelles. Scientific illustration style with labeled parts."></textarea>
        </div>
        <div class="prompt-modal-footer">
          <button class="btn btn-secondary" onclick="closePromptModal()" data-cta-id="cta-bookstudio-wysiwyg-prompt-cancel" data-action="action">Cancel</button>
          <button class="btn btn-primary" id="promptSubmitBtn" onclick="submitPrompt()" data-cta-id="cta-bookstudio-wysiwyg-prompt-submit" data-action="action">Generate</button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden File Inputs -->
    <input type="file" class="hidden-input" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
  </div>

  <script>
    // ===== STATE =====
    const state = {
      currentZoom: 100,
      unsavedChanges: new Set(['p-ch1-s1-3']), // Pre-populate with one dirty paragraph
      currentPage: 'ch1-s1',
      pages: ['cover', 'ch1-opener', 'ch1-s1', 'ch1-s2', 'ch1-s3', 'ch2-opener', 'ch2-s1', 'ch2-s2', 'ch3-opener', 'ch3-s1'],
      currentUploadTarget: null,
      currentPromptTarget: null,
    };

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', () => {
      updateUnsavedIndicator();
      setupEditableListeners();
      setupNavigation();
      setupZoom();
      showPage(state.currentPage);
    });

    // ===== ZOOM =====
    function setupZoom() {
      const slider = document.getElementById('zoomSlider');
      const value = document.getElementById('zoomValue');
      const viewport = document.getElementById('canvasViewport');

      slider.addEventListener('input', (e) => {
        const zoom = parseInt(e.target.value);
        state.currentZoom = zoom;
        value.textContent = zoom + '%';
        
        // Remove all zoom classes
        viewport.className = viewport.className.replace(/zoom-\d+/g, '');
        viewport.classList.add('zoom-' + zoom);
      });
    }

    // ===== EDITABLE TEXT =====
    function setupEditableListeners() {
      document.querySelectorAll('.editable-text').forEach(el => {
        el.addEventListener('focus', () => {
          document.getElementById('formatToolbar').classList.add('visible');
        });

        el.addEventListener('blur', () => {
          setTimeout(() => {
            if (!document.activeElement.classList.contains('editable-text')) {
              document.getElementById('formatToolbar').classList.remove('visible');
            }
          }, 100);
        });

        el.addEventListener('input', () => {
          const paragraphId = el.dataset.paragraphId;
          if (paragraphId) {
            state.unsavedChanges.add(paragraphId);
          } else {
            state.unsavedChanges.add(el.dataset.ctaId || 'unknown');
          }
          el.classList.add('dirty');
          updateUnsavedIndicator();
        });
      });
    }

    function formatText(command) {
      document.execCommand(command, false, null);
    }

    // ===== AI REWRITE =====
    function aiRewriteText(element) {
      if (!element) return;
      
      const originalText = element.textContent;
      element.classList.add('ai-loading');
      setStatus('Rewriting with AI...', true);
      
      // Simulate AI rewrite
      setTimeout(() => {
        const rewrites = [
          "This revised text demonstrates clearer, more student-friendly language while maintaining the original meaning and scientific accuracy.",
          "The fundamental concept here is that all living organisms share a common building block: the cell. This principle, known as cell theory, forms the foundation of modern biology.",
          "Understanding cellular structure is essential for comprehending how life functions at its most basic level. Each component plays a vital role in maintaining life.",
        ];
        
        const randomRewrite = rewrites[Math.floor(Math.random() * rewrites.length)];
        element.textContent = randomRewrite;
        element.classList.remove('ai-loading');
        element.classList.add('dirty');
        
        const paragraphId = element.dataset.paragraphId || element.dataset.ctaId;
        if (paragraphId) {
          state.unsavedChanges.add(paragraphId);
        }
        updateUnsavedIndicator();
        setStatus('Ready');
        showToast('AI rewrite applied', 'success');
      }, 1500);
    }

    function revertText(element) {
      if (!element) return;
      
      const original = element.dataset.original;
      if (original) {
        element.textContent = original;
        element.classList.remove('dirty');
        
        const paragraphId = element.dataset.paragraphId || element.dataset.ctaId;
        if (paragraphId) {
          state.unsavedChanges.delete(paragraphId);
        }
        updateUnsavedIndicator();
        showToast('Reverted to original', 'info');
      }
    }

    // ===== IMAGE HANDLING =====
    function triggerUpload(targetId) {
      state.currentUploadTarget = targetId;
      document.getElementById('fileInput').click();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const targetId = state.currentUploadTarget;
      if (!targetId) return;

      setStatus('Uploading image...', true);

      // Create a data URL for preview
      const reader = new FileReader();
      reader.onload = (e) => {
        const target = document.getElementById(targetId);
        if (target) {
          if (target.tagName === 'IMG') {
            target.src = e.target.result;
          } else {
            // Replace placeholder with image
            const img = document.createElement('img');
            img.className = 'figure-image';
            img.id = targetId;
            img.src = e.target.result;
            img.alt = 'Uploaded image';
            target.replaceWith(img);
          }
          
          state.unsavedChanges.add(targetId);
          updateUnsavedIndicator();
          setStatus('Ready');
          showToast('Image uploaded', 'success');
        }
      };
      reader.readAsDataURL(file);

      // Reset input
      event.target.value = '';
      state.currentUploadTarget = null;
    }

    function openPromptModal(targetId) {
      state.currentPromptTarget = targetId;
      document.getElementById('promptModal').classList.add('open');
      document.getElementById('promptInput').focus();
    }

    function closePromptModal() {
      document.getElementById('promptModal').classList.remove('open');
      document.getElementById('promptInput').value = '';
      state.currentPromptTarget = null;
    }

    function submitPrompt() {
      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt) {
        showToast('Please enter a prompt', 'error');
        return;
      }

      const targetId = state.currentPromptTarget;
      closePromptModal();
      setStatus('Generating image with AI...', true);

      // Simulate AI generation
      setTimeout(() => {
        const targetEl = document.getElementById(targetId + 'Image') || document.getElementById(targetId);
        
        // Use a random placeholder image
        const images = [
          'https://images.unsplash.com/photo-1532187863486-abf9dbad1b69?w=600&h=400&fit=crop',
          'https://images.unsplash.com/photo-1576086213369-97a306d36557?w=600&h=400&fit=crop',
          'https://images.unsplash.com/photo-1530213786676-41ad9f7736f6?w=600&h=400&fit=crop',
        ];
        const randomImage = images[Math.floor(Math.random() * images.length)];

        if (targetEl) {
          if (targetEl.tagName === 'IMG') {
            targetEl.src = randomImage;
          } else if (targetEl.classList.contains('figure-placeholder')) {
            const img = document.createElement('img');
            img.className = 'figure-image';
            img.id = targetEl.id;
            img.src = randomImage;
            img.alt = 'AI generated image';
            targetEl.replaceWith(img);
          }
          
          state.unsavedChanges.add(targetId);
          updateUnsavedIndicator();
        }

        setStatus('Ready');
        showToast('AI image generated', 'success');
      }, 2000);
    }

    function removeImage(targetId) {
      if (!confirm('Remove this image?')) return;
      
      const target = document.getElementById(targetId);
      if (target && target.tagName === 'IMG') {
        const placeholder = document.createElement('div');
        placeholder.className = 'figure-placeholder';
        placeholder.id = targetId;
        placeholder.innerHTML = `
          <span>üì∑</span>
          <span>Image removed</span>
          <button class="btn btn-sm btn-secondary" onclick="openPromptModal('${targetId.replace('Image', '')}')" data-cta-id="cta-bookstudio-wysiwyg-${targetId}-regenerate" data-action="action">Generate with AI</button>
        `;
        target.replaceWith(placeholder);
        
        state.unsavedChanges.add(targetId);
        updateUnsavedIndicator();
        showToast('Image removed', 'info');
      }
    }

    // ===== NAVIGATION =====
    function setupNavigation() {
      // Sidebar navigation
      document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('nav-toggle')) return;
          
          const page = item.dataset.page;
          if (page) {
            showPage(page);
            
            // Update active state
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
          }
        });
      });

      // Toggle sections
      document.querySelectorAll('.nav-toggle').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          const targetId = toggle.dataset.toggle + '-children';
          const children = document.getElementById(targetId);
          if (children) {
            const isHidden = children.style.display === 'none';
            children.style.display = isHidden ? 'block' : 'none';
            toggle.classList.toggle('expanded', isHidden);
          }
        });
      });

      // Page navigation buttons
      document.getElementById('prevPageBtn').addEventListener('click', () => navigatePage(-1));
      document.getElementById('nextPageBtn').addEventListener('click', () => navigatePage(1));

      // Chapter select
      document.getElementById('chapterSelect').addEventListener('change', (e) => {
        const val = e.target.value;
        if (val === 'cover') showPage('cover');
        else if (val === 'ch1') showPage('ch1-opener');
        else if (val === 'ch2') showPage('ch2-opener');
        else if (val === 'ch3') showPage('ch3-opener');
      });
    }

    function showPage(pageId) {
      state.currentPage = pageId;
      
      // For demo, we show specific pages based on ID
      // In real implementation, this would scroll to the page
      document.querySelectorAll('.book-page').forEach(page => {
        if (page.id === 'page-' + pageId) {
          page.style.display = '';
        } else if (pageId.startsWith('ch1-') && (page.id === 'page-ch1-opener' || page.id === 'page-ch1-s1')) {
          page.style.display = '';
        } else {
          page.style.display = 'none';
        }
      });

      // Scroll to page
      const targetPage = document.getElementById('page-' + pageId);
      if (targetPage) {
        targetPage.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Update page counter
      const pageIndex = state.pages.indexOf(pageId);
      document.getElementById('currentPage').textContent = pageIndex + 1;
    }

    function navigatePage(delta) {
      const currentIndex = state.pages.indexOf(state.currentPage);
      const newIndex = Math.max(0, Math.min(state.pages.length - 1, currentIndex + delta));
      
      if (newIndex !== currentIndex) {
        showPage(state.pages[newIndex]);
        
        // Update nav item
        const navItem = document.querySelector(`.nav-item[data-page="${state.pages[newIndex]}"]`);
        if (navItem) {
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          navItem.classList.add('active');
        }
      }

      // Update button states
      document.getElementById('prevPageBtn').disabled = newIndex === 0;
      document.getElementById('nextPageBtn').disabled = newIndex === state.pages.length - 1;
    }

    // ===== SAVE & DISCARD =====
    document.getElementById('saveBtn').addEventListener('click', () => {
      if (state.unsavedChanges.size === 0) {
        showToast('No changes to save', 'info');
        return;
      }

      setStatus('Saving...', true);
      
      setTimeout(() => {
        // Clear dirty states
        document.querySelectorAll('.editable-text.dirty').forEach(el => {
          el.classList.remove('dirty');
          // Update original for future reverts
          el.dataset.original = el.textContent;
        });
        
        state.unsavedChanges.clear();
        updateUnsavedIndicator();
        setStatus('Ready');
        showToast('Changes saved successfully', 'success');
      }, 1000);
    });

    document.getElementById('discardBtn').addEventListener('click', () => {
      if (state.unsavedChanges.size === 0) {
        showToast('No changes to discard', 'info');
        return;
      }

      if (!confirm('Discard all unsaved changes?')) return;

      // Revert all dirty elements
      document.querySelectorAll('.editable-text.dirty').forEach(el => {
        if (el.dataset.original) {
          el.textContent = el.dataset.original;
        }
        el.classList.remove('dirty');
      });

      state.unsavedChanges.clear();
      updateUnsavedIndicator();
      showToast('Changes discarded', 'info');
    });

    // ===== UI HELPERS =====
    function updateUnsavedIndicator() {
      const indicator = document.getElementById('unsavedIndicator');
      const count = document.getElementById('unsavedCount');
      
      if (state.unsavedChanges.size > 0) {
        indicator.style.display = 'flex';
        count.textContent = state.unsavedChanges.size + ' unsaved';
      } else {
        indicator.style.display = 'none';
      }
    }

    function setStatus(text, isWorking = false) {
      document.getElementById('statusText').textContent = text;
      const dot = document.querySelector('.status-dot');
      if (isWorking) {
        dot.classList.add('warning');
      } else {
        dot.classList.remove('warning');
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      
      const icons = {
        success: '‚úì',
        error: '‚úó',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      
      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
      `;
      
      container.appendChild(toast);
      
      // Auto-remove after 4 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(20px)';
          setTimeout(() => toast.remove(), 300);
        }
      }, 4000);
    }

    // ===== KEYBOARD SHORTCUTS =====
    document.addEventListener('keydown', (e) => {
      // Ctrl+S to save
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('saveBtn').click();
      }
      
      // Escape to close modal
      if (e.key === 'Escape') {
        closePromptModal();
      }
    });

    // Close modal on outside click
    document.getElementById('promptModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('promptModal')) {
        closePromptModal();
      }
    });
  </script>
</body>
</html>

